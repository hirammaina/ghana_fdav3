<?php
/**
 * Created by PhpStorm.
 * User: Kip
 * Date: 4/9/2019
 * Time: 8:41 PM
 */

namespace App\Modules\Reports\Traits;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Carbon;
use Illuminate\Http\Request;


use \Mpdf\Mpdf as mPDF;

use PDF;

use App\Modules\Reports\Providers\PdfProvider;
use App\Modules\Reports\Providers\PdfLettersProvider;
use App\Modules\Reports\Providers\PdfPlainLettersProvider;
use App\Modules\Reports\Providers\PdfPermitProvider;
use App\Modules\Reports\Providers\PdfPremisesLicenseProvider;

trait ReportsTrait
{

    public function generatePremisePermit($premise_id)
    {
        $params = array(
            'premise_id' => $premise_id,
            'document_type' => 'permit'
        );
        $report = generateJasperReport('premisePermitReport', 'permit_' . time(), 'pdf', $params);
        return $report;
    }

    public function generatePremiseCertificate($premise_id)
    {
        $params = array(
            'premise_id' => $premise_id,
            'document_type' => 'certificate'
        );
        $report = generateJasperReport('certificateReport', 'certificate_' . time(), 'pdf', $params);
        return $report;
    }

	function getCertificateHeader($pdf,$code){
										// add a page
										$pdf->AddPage();
										$pdf->SetLineWidth(0.4);
										//$pdf->Rect(3,3,204,290);
										$pdf->SetLineWidth(1.2);
										//$pdf->Rect(5,5,200,285);
										$pdf->SetLineWidth(0.4);
									//	$pdf->Rect(7,7,195,280);
										$pdf->setMargins(20,25,20,true);
										$template_url = base_path('/');
										$pdf->setSourceFile($template_url."resources/templates/certificate_template.pdf");

										// import page 1
										$tplId = $pdf->importPage(1);	
										// use the imported page and place it at point 10,10 with a width of 100 mm
										$pdf->useTemplate($tplId,0,0);
										$pdf->setPageMark();
										$pdf->SetLineWidth(0.4);
									//	$pdf->Rect(5,5,200,280);
										//$pdf->Rect(3,3,204,285);
			
	}
	function getPremisesCertificateHeader($pdf,$code){
										// add a page
										$pdf->AddPage();
										$pdf->SetLineWidth(0.4);
										$pdf->SetLineWidth(1.2);
										$pdf->SetLineWidth(0.4);
										$pdf->setMargins(20,25,20,true);
										$template_url = base_path('/');
										
										$pdf->setPageMark();
										$pdf->SetLineWidth(0.4);
									
	}
	
	function getImpPermitCertificateHeader($pdf,$record,$permit_title){
										// add a page
										$pdf->AddPage();
										$pdf->SetLineWidth(0.4);
										//$pdf->Rect(3,3,204,290);
										$pdf->SetLineWidth(1.2);
										//$pdf->Rect(5,5,200,285);
										$pdf->SetLineWidth(0.4);
									//	$pdf->Rect(7,7,195,280);
										$pdf->setMargins(10,10,10,true);
										//$template_url = base_path('/');
										//$pdf->setSourceFile($template_url."resources/templates/certificate_template.pdf");
										// import page 1
										//$tplId = $pdf->importPage(1);	
									
										// use the imported page and place it at point 10,10 with a width of 100 mm
										//$pdf->useTemplate($tplId,0,0);
										$pdf->setPageMark();
										$pdf->SetLineWidth(0.4);
										//$pdf->Rect(5,5,200,280);
										//$pdf->Rect(3,3,204,285);
										$org_info = getOrganisationInfo();
								//$this->funcGenerateQrCode($record,$pdf);
										$logo = getcwd() . '/resources/images/org-logo.jpg';
										$pdf->Image($logo, 10, 10, 27, 29);
										
										
										
										$pdf->SetFont('times','B',9);
										$pdf->SetFont('times','',10);
										$pdf->Cell(0,7,strtoupper($org_info->name),0,1, 'R');
										$pdf->Cell(0,7,'Telephone '.$org_info->telephone_nos,0,1, 'R');
										$pdf->Cell(0,7,'Address '.$org_info->physical_address,0,1, 'R');
										$pdf->Cell(0,7,$org_info->region_name.', '.$org_info->country_name.'. Website: '.$org_info->website,0,1, 'R');
										$pdf->ln();
										$startY = $pdf->GetY()-3;
										$startX = $pdf->GetX();
										$pdf->SetLineWidth(0.8);
										$pdf->Line(0+10,$startY,198,$startY);
										
										$pdf->SetFont('','B',15);
										$pdf->MultiCell(0,5,strtoupper($permit_title),0,'C',0,1);
										
										$pdf->SetFont('','',10);
										$pdf->Cell(0,7,'Date: '.formatDateRpt($record->approval_date),0,1, 'R');
										
			
	}
	function funcGenerateQrCode($row,$pdf){
		
								$data = url('/').'/api/permitValidation?application_code='.$row->application_code.'&module_id='.$row->module_id;

								//$data = "application_code:".$row->certificate_no."; Brand Name:".$row->brandName.";Expiry Date:".formatDate($row->expiry_date);
								 $styleQR = array('border' => false, 'padding' => 0, 'fgcolor' => array(0, 0, 0), 'bgcolor' => false);
								// QRCODE,H : QR-CODE Best error correction
								$template_url = getcwd();
								$qrc_code = $template_url . '/resources/images/qrc_code.jpg';
								$width = 16;
								$height = 16;
								
								$qr_codex = 178;
								$qr_codey = 28;
								$pdf->write2DBarcode($data, 'QRCODE,H', $qr_codex,$qr_codey , $width, $height);
							   $pdf->Image($qrc_code,$qr_codex+$width-4,$qr_codey,$width-3,$height-4);
								
		
	}
	function funcPremisesGenerateQrCode($row,$pdf){
		
								$data = url('/').'/api/permitValidation?application_code='.$row->application_code.'&module_id='.$row->module_id;
								 $styleQR = array('border' => false, 'padding' => 0, 'fgcolor' => array(0, 0, 0), 'bgcolor' => false);
									
								$template_url = getcwd();
								$qrc_code = $template_url . '/resources/images/qrc_code.jpg';
								$width = 16;
								$height = 16;
								
								$qr_codex = 150;
								$qr_codey = 210;
	$qr_codey = $pdf->GetY();
								$pdf->write2DBarcode($data, 'QRCODE,H', $qr_codex,$qr_codey , $width, $height);
							   $pdf->Image($qrc_code,$qr_codex+$width-4,$qr_codey,$width-3,$height-4);
								
		
	}
	function funcAppGenerateQrCode($row,$pdf){
		
								$data = url('/').'/permitValidation?application_code='.$row->application_code.'&module_id='.$row->module_id;

								//$data = "application_code:".$row->certificate_no."; Brand Name:".$row->brandName.";Expiry Date:".formatDate($row->expiry_date);
								 $styleQR = array('border' => false, 'padding' => 0, 'fgcolor' => array(0, 0, 0), 'bgcolor' => false);
								// QRCODE,H : QR-CODE Best error correction
								$template_url = getcwd();
								$qrc_code = $template_url . '/resources/images/qrc_code.jpg';
								$width = 16;
								$height = 16;
								
								$qr_codex = 178;
								$qr_codey = 28;
								$pdf->write2DBarcode($data, 'QRCODE,H', $qr_codex,$qr_codey , $width, $height);
							   //$pdf->Image($qrc_code,$qr_codex+$width-4,$qr_codey,$width-3,$height-4);
								
		
	}
	function funcImpGenerateQrCode($row,$pdf){
								$public_ipdomain = Config('constants.base_url.public_ipdomain');

								$data = $public_ipdomain.'permitValidation?application_code='.base64_encode($row->application_code).'&module_id='.base64_encode($row->module_id);

								//$data = "application_code:".$row->certificate_no."; Brand Name:".$row->brandName.";Expiry Date:".formatDate($row->expiry_date);
								 $styleQR = array('border' => false, 'padding' => 0, 'fgcolor' => array(0, 0, 0), 'bgcolor' => false);
								// QRCODE,H : QR-CODE Best error correction
								$template_url = getcwd();
								$qrc_code = $template_url . '/resources/images/qrc_code.jpg';
								$width = 16;
								$height = 16;
								
								$qr_codex = 178;
								$qr_codey = 65;
								$pdf->write2DBarcode($data, 'QRCODE,H', $qr_codex,$qr_codey , $width, $height);
							   //$pdf->Image($qrc_code,$qr_codex+$width-4,$qr_codey,$width-3,$height-4);
								
		
	}

	public function foodProductRegistrationCertificate($application_code,$row){
		try{
			
						
						$is_provisional =0;
						
						if($row){
							if($row->recommendation_id == 2){
								$is_provisional =1;
							}
							$org_info = getOrganisationInfo();
								
								$pdf = new PdfProvider();
								$this->getCertificateHeader($pdf, 'DAR/FMT/042');
								
								$logo = getcwd() . '/resources/images/org-logo.jpg';
								$pdf->SetFont('times','B',9);
								$pdf->Cell(0,1,'',0,1);
								
								
								$pdf->Cell(0,21,'',0,1);
								
								$pdf->Cell(0,5,'REGISTRATION CERTIFICATE OF FOOD PRODUCT',0,1,'C');
								$pdf->SetFont('times','',10);
								$pdf->ln();
								$act_statement = "Made under Law No. 003/2018 of 09/02/2018 establishing the Rwanda FDA and determining its mission, organization and functioning in his article 3 and article 8 and regulation No. CBD/TRG/010. The Authority here issues.\n";
								
								$pdf->MultiCell(0,5,$act_statement,0,'J',0,1);
							
								$pdf->SetFont('times','B',10);
								$pdf->Cell(0,3,'',0,1);
								
								$pdf->SetFont('times','',10);
									
                                if( $is_provisional == 1){
                                   // $pdf->Cell(70,8,0,0);
									$pdf->MultiCell(70,8,'Provisional registration number of the medicine',0,'',0,0);
                                }
                                else{
                                    $pdf->Cell(70,8,'Registration number:',0,0);
								
                                }
								
								$pdf->SetFont('times','B',10);
								$pdf->Cell(100,8,$row->certificate_no,0,1);
								//$pdf->Cell(0,1,'',0,2);
								$pdf->SetFont('times','',10);
								
								//Brand Name
								$pdf->MultiCell(0,8,"This is to certify that the medicine described below has been registered in Rwanda subject to conditions indicated at the back of the this certificate:\n",0,'J',0,1);
							
								$pdf->SetFont('times','',10);
									
								$pdf->MultiCell(70,8,'Brand Name:',0,'',0,0);
								$pdf->SetFont('times','B',10);
								
								$pdf->MultiCell(0,8,strtoupper($row->brandName),0,'',0,1);
								$pdf->SetFont('times','',10);
								
								$pdf->MultiCell(70,8,'Common Name:',0,'',0,0);
								$pdf->SetFont('times','B',10);
								
								$pdf->MultiCell(0,8,strtoupper($row->common_names),0,'',0,1);
								
								$pdf->SetFont('times','',10);
								$pdf->MultiCell(69,10,'Pack size and Packaging type:',0,'',0,0);
								//$pdf->Cell(70,5,'',0,0,'L');
								
								$pdf->SetFont('times','B',10);
								$packaging = '';
											$container_name = '';
											$retail_packaging_size = '';
								$packaging_data = DB::table('tra_product_packaging as t1')
											->select(DB::raw("t1.*, t2.name as container_type, t3.name as container_name, t4.name as container_material, t5.name as closure_materials, t4.name as container_material, t5.name as closure_material, t6.name as seal_type, t7.name as packaging_units, CONCAT_WS('X',retail_packaging_size,retail_packaging_size1,retail_packaging_size2,retail_packaging_size3,retail_packaging_size4) as retail_packaging"))
											->leftJoin('par_containers_types as t2', 't1.container_type_id', '=', 't2.id')
											->leftJoin('par_containers as t3', 't1.container_id', '=', 't3.id')
											->leftJoin('par_containers_materials as t4', 't1.container_material_id', '=', 't4.id')
											->leftJoin('par_closure_materials as t5', 't1.closure_material_id', '=', 't5.id')
											->leftJoin('par_seal_types as t6', 't1.seal_type_id', '=', 't6.id')
											->leftJoin('par_packaging_units as t7', 't1.packaging_units_id', '=', 't7.id')
											->where(array('t1.product_id' => $row->product_id))
											->get();
								
								if($packaging_data->count() >0){
								$i = 1;
									foreach($packaging_data as $packaging_rec){
										
											$container_material = $packaging_rec->container_material;
											$container_name = $packaging_rec->container_name;
											
											$retail_packaging_size = $packaging_rec->retail_packaging;
											
											$product_unit = $packaging_rec->unit_pack;		
											if($i != 1){
												$pdf->Cell(69,5,'',0,0);
											}									
											if($product_unit == ''){
											
													$pdf->MultiCell(0,5,strtoupper($container_material).' '.strtoupper($container_name) .' OF '.strtoupper($retail_packaging_size),0,'',0,1);
											}
											else{
												
													$pdf->MultiCell(0,5,strtoupper($container_material).' '.strtoupper($container_name) .' OF '.strtoupper($retail_packaging_size).' X '.strtoupper($product_unit),0,'',0,1);													
																							
											}
											
											$i++;									
									}
											
								
								}
								else{
											$pdf->MultiCell(0,10,'',0,'',0,1);
											
								}
								
								$pdf->SetFont('times','',10);
								$pdf->MultiCell(70,8,'Shelf life of medicine in months and Storage statement:',0,'',0,0); ;
								
								$pdf->SetFont('times','B',10);
								$pdf->MultiCell(100,8,strtoupper($row->shelf_life).', '.strtoupper(html_entity_decode(($row->storage_condition))),0,'',0,1); ;
								
								$pdf->SetFont('times','B',10);
								
								
								$pdf->MultiCell(70,10,'Name of Marketing authorization holder:',0,'',0,0);
								
								$pdf->SetFont('times','B',10);
								$pdf->MultiCell(0,10,strtoupper($row->trader_name),0,'',0,1);
								//$pdf->Cell(100,12,ucwords($applicantName),0,1,'L'); 
								//$pdf->Cell(0,1,'',0,1);
								//Manufacturer
								 $manrow = DB::table('tra_product_manufacturers as t1')
									->select('t1.*', 't2.email_address','t1.id as manufacturer_id', 't2.physical_address', 't2.name as manufacturer_name','t2.postal_address', 't3.name as country_name', 't4.name as region_name', 't5.name as district_name')
									->join('tra_manufacturers_information as t2', 't1.manufacturer_id', '=', 't2.id')
									->join('par_countries as t3', 't2.country_id', '=', 't3.id')
									->leftJoin('par_regions as t4', 't2.region_id', '=', 't4.id')
									->leftJoin('par_districts as t5', 't2.district_id', '=', 't5.id')
									->leftJoin('par_manufacturing_roles as t6', 't1.manufacturer_role_id', '=', 't6.id')
									->where(array('t1.product_id' => $row->product_id, 'manufacturer_type_id' => 1))
									->first();
									
									$manufacturer_name='';
									$man_postal_address='';
									$man_physical_address='';
									$man_countryName='';
									$man_districtName='';
									$man_regionName = '';
									
								if($manrow){
									$manufacturer_name=$manrow->manufacturer_name;
									$man_postal_address=$manrow->postal_address;
									$man_physical_address=$manrow->physical_address;
									
									$man_countryName= $manrow->country_name;
									$man_regionName = $manrow->region_name;
								}
								
								//Manufacturer sql 
								$pdf->SetFont('times','',10);
								
								$pdf->MultiCell(70,10,'Name and Address of the Manufacturer:',0,'',0,0);
								$pdf->SetFont('times','B',10);
								$pdf->MultiCell(0,5,strtoupper($manufacturer_name),0,'',0,1);
								
								$pdf->SetFont('times','',10);
								$pdf->Cell(70,5,'',0,0,'L');
								$pdf->SetFont('times','B',10);
								$pdf->MultiCell(0,5,strtoupper($man_postal_address),0,'',0,1);
								$pdf->Cell(70,5,'',0,0,'L');
								$pdf->SetFont('times','B',10);
								$pdf->MultiCell(0,5,strtoupper($man_physical_address),0,'L');
								
								if($man_regionName!=''){
									$pdf->Cell(70,5,'',0,0,'L');
									$pdf->SetFont('times','B',10);
									$pdf->Cell(100,5,strtoupper($man_regionName),0,1,'L'); 
								}
								$pdf->Cell(70,5,'',0,0,'L');
								$pdf->SetFont('times','B',10);
								$pdf->Cell(100,5,strtoupper($man_countryName),0,1,'L'); 
								 
								$pdf->SetFont('times','',10);
								$pdf->MultiCell(70,8,'Name of Local Technical Representative:',0,'',0,0);
								
								$pdf->SetFont('times','B',10);
								$pdf->MultiCell(0,8,strtoupper($row->localAgentName),0,'',0,1);
								
								$pdf->SetFont('times','',10);
								$pdf->Cell(70,8,'Valid From:',0,0,'L');
								$pdf->SetFont('times','B',10);
								$pdf->Cell(35,8,ucwords(date('F d, Y ',strtotime($row->certificate_issue_date))),0,0,'L'); 
								
								
								$pdf->SetFont('times','',10);
								$pdf->Cell(30,8,'To:',0,0,'L');
								$pdf->SetFont('times','B',10);
								$pdf->Cell(0,8,ucwords(date('F d, Y ',strtotime($row->expiry_date))),0,1,'L'); 
								
								
								$pdf->Cell(0,2,'',0,1);
								$permit_signitory = '';
								$title= 'ACTING';
								$title= '';
								$approved_by = '';
								$this->funcGenerateQrCode($row,$pdf);
								
								$this->getCertificateSignatoryDetail($row,$pdf);
								
								$pdf->AddPage();
								$pdf->SetFont('times','B',9);
								
								
								$pdf->Cell(0,5,'Conditions of Registration:',0,1);
								$pdf->SetFont('times','',11);
								$pdf->Cell(0,2,'',0,1);
								
								$this->getCertificateRegistrationConditions($row,$pdf);
								
								$pdf->Output();
						}	
							
								
			
			
		} catch (\Exception $exception) {
				//DB::rollBack();
				$res = array(
					'success' => false,
					'message' => $exception->getMessage()
				);
			} catch (\Throwable $throwable) {
				//DB::rollBack();
				$res = array(
					'success' => false,
					'message' => $throwable->getMessage()
				);
			}
			//
			//exit();
        return response()->json($res);
		
	}
	function printPremisesCertificateLetter($request,$approvalGrant){
		try{
			$application_code = $request->application_code;
			
			$record = DB::table('tra_premises_applications as t1')
												->join('tra_premises as t2', 't1.premise_id','t2.id')
												->join('par_countries as t3', 't2.country_id', 't3.id')
												->leftJoin('par_regions as t4', 't2.region_id','t4.id')
												->leftJoin('par_districts as t5', 't2.district_id', 't5.id')
												->join('wb_trader_account as t6', 't1.applicant_id', 't6.id')
												->leftJoin('par_countries as t7', 't6.country_id', 't7.id')
												->leftJoin('par_regions as t8', 't6.region_id','t8.id')
												->leftJoin('par_districts as t9', 't6.district_id', 't9.id')
												->leftJoin('par_business_types as t11', 't2.business_type_id', 't11.id')
												->leftJoin('par_sectors as t12', 't2.sector_id', 't12.id')
												->leftJoin('par_cells as t13', 't2.cell_id', 't13.id')
												->leftJoin('tra_approval_recommendations as t10','t1.application_code','t10.application_code')
												->leftJoin('users as t17', 't10.permit_signatory', '=', 't17.id')
												->leftJoin('par_sections as t18', 't1.section_id', '=', 't18.id')
							
												->select(DB::raw("t1.reference_no,t18.name as section_name, t13.name as cell_name, t12.name as sector_name,t1.application_code,t1.*,concat(decrypt(t17.first_name),' ',decrypt(t17.last_name)) as permit_signatoryname, t2.*, t10.permit_signatory,t1.premise_id,  t2.postal_address as premise_poastal_address,t11.name as premises_type,t11.license_title, t2.physical_address as premise_physical_address, t4.name as premise_region_name,t5.name as premise_district_name,t7.name as premise_country,t1.date_added as date_registered,t10.id as decision_record,t10.decision_id, t10.expiry_date,t10.approval_date as permit_issue_date,t10.permit_no,t2.premise_reg_no,t2.name as premise_name,t6.name as applicant_name,t6.physical_address,t6.postal_address,t6.telephone_no as telephone,t6.email,t9.name as districtName,t8.name as regionName,t7.name as countryName, t11.is_manufacturer"))
												->where(array('t1.application_code'=>$application_code))
												->first();
									
						if(!validateIsNumeric($record->decision_record) || $record->decision_id == 1){
											$org_info = getOrganisationInfo();
											
											$pdf = new PdfPremisesLicenseProvider();
											$this->getPremisesCertificateHeader($pdf, '');
											
											
											$pdf->setCellHeightRatio(1.5); 
											$logo = getcwd() . '/resources/images/org-logo.jpg';
											$pdf->SetFont('times','B',9);
											$pdf->Cell(0,1,'',0,1);
											
											$pdf->Cell(0,8,'',0,1);
											$pdf->ln();
														$personnel  ='';	
											if($record){
														$row=$record;
														$applicantName=$row->applicant_name;
														$premise_name=$row->premise_name;
														$reference_no=$row->reference_no;
														$permit_no=$row->permit_no;
																			
														$date_added=$row->date_registered;
														$postal_address=$row->postal_address;
														$physical_address=$row->physical_address;
														$countryName=$row->countryName;
														$regionName=$row->regionName;
														$districtName=$row->districtName;
														$premiseID=$row->premise_id;
														$premise_reg_no=$row->premise_reg_no;
														$premises_id = $row->premise_id;
														$permit_issue_date = $row->permit_issue_date;
														$locationDesc ='';
														$org_info = getOrganisationInfo();

														$premise_name = $row->premise_name;
														$premise_poastal_address = $row->premise_poastal_address;
														$premise_physical_address = $row->premise_physical_address;
														$premise_region_name = $row->premise_region_name;
														$premise_country = $row->premise_country;
														$premise_district_name = $row->premise_district_name;
														
														//if($row->section_id == 1){
																		$pdf->ln();$pdf->SetFont('times','B',12);
														$pdf->Cell(0,5,'Premise registration certificate No: '.$premise_reg_no,0,1,'C');

																		
																if($row->is_manufacturer){
$pdf->SetFont('times','B',15);
																		$pdf->Cell(0,5,'PREMISE LICENSE FOR '.strtoupper($record->license_title),0,1,'C');$pdf->SetFont('times','',11);
																		
																		$pdf->SetFont('times','B',10);
																		
																		$pdf->Cell(0,6,'This is to certify that',0,1,'');
																		$pdf->Cell(0,6,'Premise License No: 	'.$record->permit_no,0,1,'');
																		$pdf->SetFont('times','B',10);
																		
																		$pdf->Cell(0,6,'was granted to:',0,1,'');
																		$pdf->SetFont('times','B',10);
																		
																		$pdf->MultiCell(55,6,'Name of the Company: ',0,'',0,0);
																			$pdf->SetFont('times','',10);
																		
																		$pdf->MultiCell(0,6,$record->premise_name,0,'',0,1);
																			$pdf->SetFont('times','B',10);
																		
																		$pdf->MultiCell(55,6,'Company Code:	 ',0,'',0,0);
																		$pdf->SetFont('times','',10);
																		
																		$pdf->MultiCell(0,6,$record->company_registration_no,0,'',0,1);
																		$pdf->SetFont('times','B',10);
																		
																		$pdf->MultiCell(55,6,'Location of the premises:',0,'',0,0);
																		$pdf->SetFont('times','',10);
																		
																		$pdf->MultiCell(0,6,$record->premise_region_name.", " .$record->premise_district_name.", ".$record->sector_name.", ".$record->cell_name,0,'',0,1);$pdf->SetFont('times','B',10);
																		$pdf->ln();
																		$pdf->MultiCell(55,6,'Name of the Managing Director:',0,'',0,0);
																		$pdf->SetFont('times','',10);
																		
																		$pdf->MultiCell(0,6,$record->managing_director,0,'',0,1);
																		$pdf->SetFont('times','B',10);
																		
																		$pdf->MultiCell(55,6,'Telephone No:',0,'',0,0);
																		$pdf->SetFont('times','',10);
																		
																		$pdf->MultiCell(0,6,$record->managing_director_telepone,0,'',0,1);
																		$personnel = "";
																		$prem_per = DB::table('tra_premises_personnel as t1')
																						->join('tra_personnel_information as t2', 't1.personnel_id','t2.id')
																						->join('par_personnel_positions as t3', 't1.position_id','t3.id')
																						->where(array('t1.premise_id'=>$record->premise_id, 'position_id'=>1))
																						->first();
																		if($prem_per){
																								$personnel = $prem_per->name;
																								$registration_no = $prem_per->registration_no;

																		}$pdf->SetFont('times','B',10);
																		
																		$pdf->MultiCell(50,8,'Head of Production Department:',0,'',0,0);
$pdf->SetFont('times','',10);
																		
																		$pdf->MultiCell(0,8,$personnel,0,'',0,1);
																		$pdf->ln();
																		$pdf->Cell(0,8,'to carry out the following manufacturing activities: ',0,1,'');
																		  $premises_operations = DB::table('tra_premises_otherdetails as t1')
																		->join('par_business_types as t2', 't1.business_type_id', '=', 't2.id')
																		->leftJoin('par_business_type_details as t3', 't1.business_type_detail_id', '=', 't3.id')
																		->leftJoin('par_product_categories as t4', 't1.product_category_id', '=', 't4.id')
																		->leftJoin('par_subproduct_categories as t5', 't1.product_subcategory_id', '=', 't5.id')
																		->select('t1.*','t4.name as product_category', 't5.name as product_subcategory', 't2.name as business_type', 't3.name as business_type_detail')
																		->where('t1.premise_id', $premises_id)
																		->get();$pdf->SetFont('times','B',10);
																		
																		$pdf->Cell(50,5,'Product category',1,0,'');
																		$pdf->Cell(50,5,'Product type',1,0,'');
																		$pdf->Cell(0,5,'Manufacturing activities',1,1,'');

																		if($premises_operations){
																			$pdf->SetFont('times','',10);
																		
																			foreach($premises_operations  as $operation){
																$manufatcuring_activities = 'Production, packaging, labeling, storage and distribution';
																$rowcount = max(PDF::getNumLines($operation->product_category, 50),PDF::getNumLines($operation->product_subcategory, 50),PDF::getNumLines($manufatcuring_activities, 55));
																					
										$pdf->MultiCell(50,$rowcount*5,$operation->product_category,1,'',0,0);
																					$pdf->MultiCell(50,$rowcount*5,$operation->product_subcategory,1,'',0,0);
																					$pdf->MultiCell(0,$rowcount*5,$manufatcuring_activities,1,'',0,1);
																		

											
																			}

																		}$pdf->Cell(0,5,'',0,1);

																$pdf->Cell(0,5,'This license is valid until 18/10/2023',0,1);
		
																$pdf->Cell(0,5,'',0,1);

																		$pdf->MultiCell(0,10,'This premise license may be suspended or withdrawn if the conditions under which it was granted are violated. The product is put on market after its assessment and registration by Rwanda FDA. The application for renewal of license shall be due one month before its expiry.',0,'',0,1);
																			$pdf->Cell(0,5,'',0,1);
																		$pdf->Cell(0,5,'Done at Kigali on : '.formatDateRpt($record->permit_issue_date),0,1);
																		
																		$permit_signitory = '';
																		$title= 'ACTING';
																		$title= '';
																		$approved_by = '';
																		//application_code
																		$this->getCertificateSignatoryDetail($record,$pdf);
																		$pdf->Output();
																		$i= 1;
																		$l =1;
																		
														}
														
														else{
$pdf->SetFont('times','B',15);
																		$pdf->Cell(0,2,'',0,1);
																$pdf->Cell(0,3,'PREMISE LICENSE',0,1,'C');	$pdf->Cell(0,2,'',0,1);
			$pdf->SetFont('times','',11);
																		
																$premises_statement1 = "This is to certify that <b>".strtoupper($record->premise_name)."</b> with premise license number<b>".$permit_no."</b> under company code <b>".$record->company_registration_no."</b> licensed to store and operate as <b>".strtoupper($record->license_title)."</b> on the following location:\n";
															$pdf->WriteHTML($premises_statement1, true, false, true, true, 'J');
																$pdf->SetFont('times','B',11);
$pdf->Cell(0,2,'',0,1);
																$pdf->MultiCell(60,4,'Sales room:',0,'',0,0);
																$pdf->SetFont('times','',11);
																		
																$pdf->MultiCell(0,8,$record->premise_region_name.", " .$record->premise_district_name.", ".$record->sector_name.", ".$record->cell_name,0,'',0,1);
$pdf->SetFont('times','B',11);
																		
																$pdf->MultiCell(60,8,'Store Room 1:',0,'',0,0);
$pdf->SetFont('times','',11);
																		
																$pdf->MultiCell(0,8,$record->premise_region_name.", " .$record->premise_district_name.", ".$record->sector_name.", ".$record->cell_name,0,'',0,1);
$pdf->Cell(0,2,'',0,1);
																		$pdf->SetFont('times','B',11);
																		$pdf->MultiCell(60,5,'Name of the Managing Director:',0,'',0,0);
																		$pdf->SetFont('times','',11);
																		
																		$pdf->MultiCell(0,8,$record->managing_director,0,'',0,1);
																		$pdf->SetFont('times','B',11);
																		
																		$pdf->MultiCell(60,8,'Telephone No:',0,'',0,0);
																		$pdf->SetFont('times','',11);
																		
																		$pdf->MultiCell(0,5,$record->managing_director_telepone,0,'',0,1);
$pdf->Cell(0,2,'',0,1);
																$pdf->Cell(0,5,'This license is valid until '.formatDateRpt($record->expiry_date),0,1);
																	$pdf->SetFont('times','BI',11);
$pdf->Cell(0,2,'',0,1);
																		$pdf->Cell(0,5,'N.B',0,0);
																$pdf->ln();$pdf->SetFont('times','',11);
																$this->getCertificateRegistrationConditions($record,$pdf);
																$pdf->ln();
$pdf->SetFont('times','B',11);
																		
																$pdf->Cell(0,5,'Done at Kigali on : '.formatDateRpt($record->permit_issue_date),0,1);
																		
																$permit_signitory = '';
																		$title= 'ACTING';
																		$title= '';
																		$approved_by = '';
																		$this->funcPremisesGenerateQrCode($record,$pdf);
	
																		$this->getCertificateSignatoryDetail($record,$pdf);
																		$pdf->Output();	

														}
										


												 
											}
												
        }else{
            return "Set rejection letter";
        }
        
				
		} catch (\Exception $exception) {
				//DB::rollBack();
				$res = array(
					'success' => false,
					'message' => $exception->getMessage()
				);
			} catch (\Throwable $throwable) {
				//DB::rollBack();
				$res = array(
					'success' => false,
					'message' => $throwable->getMessage()
				);
			}

			//
			//exit();
        return response()->json($res);
		
		
		
		
	}
	public function printDisposalCertificate($application_code){
									
					$logo=getcwd().'/assets/images/logo.jpg';
					
					
					$records = DB::table('tra_disposal_applications as t1')
										->join('wb_trader_account as t2', 't1.applicant_id', 't2.id')
										->leftJoin('par_districts as t7', 't7.id', 't2.district_id')
										->leftJoin('par_regions as t3', 't2.region_id', 't3.id')
										->leftJoin('par_currencies as t4', 't1.currency_id', 't4.id')
										->leftJoin('par_weights_units as t5', 't1.weights_units_id', 't5.id')
										->leftJoin('par_currencies as t8', 't8.id', 't1.currency_id')
										->join('tra_approval_recommendations as t6', 't1.application_code', 't6.application_code')
										->leftJoin('users as t17', 't6.permit_signatory', '=', 't17.id')
										->select(DB::raw("t4.name as currency,total_weight,t8.name as currency_name, t6.permit_signatory,concat(decrypt(t17.first_name),' ',decrypt(t17.last_name)) as permit_signatoryname, market_value, t5.name as weights_units ,t2.name as applicant,t7.name as district_name, t2.physical_address, t3.name as region_name,t6.approval_date, t2.postal_address, t1.*, t6.decision_id"))
										->where(array('t1.application_code'=>$application_code))
										->first();
				
					if($records){
						$row = $records;
						if($row->decision_id == 1){
								$record = $records;
								$org_info = getOrganisationInfo();
												
								$pdf = new PdfProvider();
								$this->getCertificateHeader($pdf, '');
											
								$this->funcGenerateQrCode($record,$pdf);
												
											
											$logo = getcwd() . '/resources/images/org-logo.jpg';
											$pdf->SetFont('times','B',9);
											$pdf->Cell(0,1,'',0,1);
											//$pdf->Image($logo, 86, 18, 40, 35);
											
											
											$pdf->Cell(0,21,'',0,1);
											$pdf->Cell(0,5,'P.O. Box '.$org_info->postal_address.' '.$org_info->region_name,0,1);
											$pdf->Cell(0,5,$org_info->email_address,0,1);
											$pdf->Cell(0,5,$org_info->website,0,1);
											$pdf->ln();
										
								$reference_no  = $records->tracking_no ;
								$applicant_name   = $records->applicant ;
								$district_name  = $records->district_name ;
								$region_name  = $records->region_name ;
								$physical_address  = $records->physical_address ;
								$pdf->Cell(0,5,'',0,1,'C');
								$pdf->SetFont('','BI',10);
								$pdf->Cell(40,5,'Ref No: '.$reference_no,0,0);
								$pdf->Cell(0,5,'Date: '.date('jS F, Y',strtotime($row->approval_date)),0,1,'R');
								$pdf->ln();$pdf->SetFont('','B',12);
								
								$pdf->MultiCell(0,5,'CERTIFICATE OF SAFE DISPOSAL OF SUBSTANDARD, FALSIFIED AND EXPIRED REGULATED PRODUCTS',0,'C',0,1);
								
								$pdf->ln();$pdf->SetFont('','',10);
								$destruction_startdate = formatDaterpt($row->destruction_startdate);
								$destruction_enddate = formatDaterpt($row->destruction_enddate);
								if($destruction_startdate == $destruction_enddate){
									$date_of_destruction =  date('jS F, Y',strtotime($row->destruction_enddate));
								}
								else{
									$date_of_destruction =   date('jS F, Y',strtotime($row->destruction_startdate)).' to '.  date('jS F, Y',strtotime($row->destruction_enddate));
								}
								$text= "Reference is made to the Law Nº 003/2018 of 09/02/2018 establishing Rwanda Food and Drugs Authority and determining its mission, organization and functioning especially in its article 8; and considering the provisions of the Law No 47/2012 of 14/01/2013 relating to the regulation and inspection of food and pharmaceutical products especially in its article 38;.\n";
								$pdf->setCellHeightRatio(2);
								$pdf->writeHTML($text, true, false, false, false, 'J');
		
								$methodsof_destructionsdata = DB::table('tra_methodsof_destructions as t1')
																		->join('par_destruction_methods as t2', 't1.destructionmethod_id', 't2.id')
																		->select('t2.name as disposal_method')

																		->where(array('application_code'=>$application_code));
										$methods = '';								
								if($methodsof_destructionsdata->get()){
									$i = 1;
									$totals = $methodsof_destructionsdata->count();
										$results =$methodsof_destructionsdata->get();
									
									foreach($results as $rows){
										
										if($totals == $i && $i != 1){
											$methods .= ' and '.$rows->disposal_method;
										}
										else{
											if(($i+1) == $totals ){
												$methods .= $rows->disposal_method;
											}
											else{
												
												$methods .= $rows->disposal_method.',';
											}
											
										}
										$i++;
									}
									
								}
							$destruction_sites = DB::table('tra_destruction_exercisesites as t1')
																		->join('par_disposaldestruction_sites as t2', 't1.destruction_site_id', 't2.id')
																		->select('t2.name as destruction_site')

																		->where(array('application_code'=>$application_code));
										$destruction_site  = '';								
								if($destruction_sites->get()){
									$i = 1;
									$totals = $destruction_sites->count();
										$results =$destruction_sites->get();
									
									foreach($results as $rows){
										
										if($totals == $i && $i != 1){
											$destruction_site .= ' and '.$rows->destruction_site;
										}
										else{
											if(($i+1) == $totals ){
												$destruction_site .= $rows->destruction_site;
											}
											else{
												
												$destruction_site .= $rows->destruction_site.',';
											}
											
										}
										$i++;
									}
									
								}
							
								$records = DB::table('tra_disposal_inspectors as t1')
								->join('par_disposal_inspectors_titles as t2', 't1.inspectors_title_id', '=', 't2.id')
								->select(DB::raw("count(t1.id) as counter, t2.name as title"))
								->where(array('t1.application_code' => $application_code))
								->groupBy('t2.id');
		$witness = '';
								if(	$records->get()){
									$i = 1;
									
									
									$totals = $records->count();
									$records = $records->get();
									foreach($records as $rows){
										$counter = '';
										if($rows->counter > 1){
											$counter = $rows->counter.' ';
										}
										
										if($totals == $i && $i != 1){
											$witness .= ' and '.$counter.$rows->title;
										}
										else{
											if(($i+1) == $totals ){
												$witness .= $counter.$rows->title;
											}else{
												$witness .= $counter.$rows->title.', ';
											}
										}
										$i++;
									}
									
								}//destruction_site
								$weight_consignement = $row->total_weight.' '. $row->weights_units;
								$market_value = formatMoney($row->market_value).' '. $row->currency_name;
 
								$pdf->Cell(0,2,'',0,1);
								$text2 = "Rwanda FDA, hereby certifies the disposal of substandard/ falsified/ expired products being the property of the company named <b>".$applicant_name."</b>.located in <b>".$region_name."</b/> Province, <b>".$district_name."</b> District, <b>".$physical_address."</b> which took place on <b>".$date_of_destruction."</b>.\n";
								$pdf->writeHTML($text2, true, false, false, false, 'J');
								$pdf->Cell(0,2,'',0,1);
								$text3 = "The annexed consignment was destroyed by <b>".$methods ."</b>(method) at <b>".$destruction_site."</b>(location/site) under the witness and supervision of (Rwanda FDA Inspectors, and others if any) as specified in the attached disposal form. The weight of the consignment disposed was <b>".$weight_consignement."</b> and its market value was <b>".$market_value."</b>.\n";
								$pdf->writeHTML($text3, true, false, false, false, 'J');
								$pdf->SetFont('','B',10);
								$pdf->ln();
								$pdf->Cell(0,5,'Done at Kigali on : '.formatDateRpt($record->approval_date),0,1);
												
								
								$permit_signitory = '';
								$title= 'ACTING';
								$title= '';
								$approved_by = '';
												
								$this->getCertificateSignatoryDetail($record,$pdf);
																

						}else{

						}
					}
						$pdf->Output('Disposal Certificate.pdf');


		
		
		
		
	}
	public function generateLetterOfREjection($application_code,$req,$module_id)
{
	try{

																	$application_code = $req->application_code;
																	
																	$query_id = $req->query_id;
																	$module_data = getTableData('modules', ['id'=>$module_id]);
																	if(!isset($module_data->table_name)){
																		return "Module details not found";
																	}
																	$app_data = DB::table($module_data->table_name.' as t1')
																				->join('wb_trader_account as t2', 't1.applicant_id', 't2.id')
																				->leftJoin('par_countries as t3', 't2.country_id', 't3.id')
																				->leftJoin('par_regions as t4', 't2.region_id', 't4.id')
																				->leftJoin('sub_modules as t5', 't1.sub_module_id', 't5.id')
																				->leftJoin('tra_apprejprovisional_recommendation as t7', 't1.application_code', 't7.application_code')
																				->where('t1.application_code', $application_code);
																	
																	if($module_id ==1){
																		$app_data->join('tra_product_information as t6', 't1.product_id','t6.id')->select('t7.created_on as approval_date', 't7.reason_for_rejection','t1.applicant_id','t5.title as application_title','t1.reference_no', 't1.tracking_no', 't2.*', 't3.name as country_name', 't4.name as region_name', 't6.brand_name');
																	}
																	else{
																		$app_data->select('t7.created_on as approval_date', 't7.reason_for_rejection','t1.applicant_id','t5.title as application_title','t1.reference_no', 't1.tracking_no', 't2.*', 't3.name as country_name', 't4.name as region_name');
																	}
																	$app_data = $app_data->first();
																
																	if(!$app_data){
																		return "Application details not found";
																	}
																	
																	$org_info = getOrganisationInfo();
																	$pdf = new PdfLettersProvider();
																	$pdf->AddPage();
																	//$pdf->SetLineWidth(0.4);
																	//$pdf->Rect(3,3,204,285);
																		$template_url = base_path('/');
																		$pdf->setSourceFile($template_url."resources/templates/certificate_template.pdf");
																		// import page 1
																		$tplId = $pdf->importPage(1);	
																	
																		// use the imported page and place it at point 10,10 with a width of 100 mm
																		$pdf->useTemplate($tplId,0,0);
																		$pdf->setPageMark();
																	//use template 
																	
																	$logo = getcwd() . '/resources/images/zamra-logo.png';
																	$pdf->Image($logo, 86, 18, 40, 35);
																	
																	$pdf->SetFont('times','B',9);
																	
																	
																	$pdf->Cell(0,4,'FORM II',0,1,'R');
																	$pdf->Cell(0,4,'(Regulation 3)',0,1,'R');
																	$pdf->SetFont('times','B',13);
																	$pdf->Cell(0,25,'',0,1);
																	$pdf->Cell(0,15,'',0,1);
																	$pdf->Cell(0,4,$org_info->org_name,0,1,'C');
																	$pdf->SetFont('times','B',11);
																	$pdf->Cell(0,4,'The Medicines and Allied Substances Act, 2013',0,1,'C');
																	
																	
																	$pdf->Cell(0,4,'(Act No. 3 of 2013)',0,1,'C');
																	$pdf->SetFont('times','B',12);
																	$pdf->Cell(0,8,'The Medicines and Allied Substances',0,1,'C');
																	$pdf->SetFont('times','B',11);
																	if($module_id == 4){
																			$regulation_title = "The Medicines and Allied Substances (Importation and Exportaion) Regulations, 2017";
																			
																	}
																	else if($module_id == 1){
																		$regulation_title = "(Marketing Authorisation of Medicines) Regulations, 2019";
																	
																	}
																	$pdf->Cell(0,4,$regulation_title,0,1,'C');

																	$pdf->Cell(0,5,'',0,1);
																	$pdf->SetFont('times','B',13);
																	//application_title
																	$title = "NOTICE OF REJECTION OF ".$app_data->application_title;

																	$pdf->Cell(0,5,strtoupper($title),0,1,'C');
																	$pdf->SetFont('times','B',10);
																	
																	$application_no = '';

																	if($app_data->tracking_no != ''){

																		$application_no = 	$app_data->tracking_no;
																	}
																	if($app_data->reference_no != ''){

																		$application_no = 	$app_data->reference_no;
																	}
																	$pdf->Cell(0,10,'Application No:'.$application_no,0,1, 'R');
																		// $pdf->MultiCell(0,10,'Application Reference:<u>'.$app_data->tracking_no.'</u>',0,'R',0,1,'','',true,0,true);
																	$data = '{"tracking_no":'.$app_data->tracking_no.',"module_id":'.$module_id.',"application_code":'.$application_code.'}';

																	$styleQR = array('border' => false, 'padding' => 0, 'fgcolor' => array(0, 0, 0), 'bgcolor' => false);
																	// QRCODE,H : QR-CODE Best error correction
																	$pdf->write2DBarcode($data, 'QRCODE,H', 178, 28, 16, 16);
																	$pdf->SetFont('times','',12);
																	//Letter heading 
																	$pdf->Cell(0,8,'To:',0,1);
																	$pdf->Cell(0,8,$app_data->name.',',0,1);
																	
																	$pdf->Cell(0,8,$app_data->physical_address.',',0,1);
																	$pdf->Cell(0,8,$app_data->postal_address.',',0,1);
																	$pdf->Cell(0,8,$app_data->region_name." ".$app_data->country_name,0,1);
																	
																	$pdf->SetFont('times','',11);
																	$pdf->ln();
																		
																	if($module_id ==1){

																		$template = "IN THE MATTER OF ".$application_no.' '.$app_data->brand_name." you are notified that your application for (3) a marketing authorisation/renewal of a marketing authorisation has been rejected by the Authority on the following grounds:";
																
																	}
																	else{
																		$template = "IN THE MATTER OF ".$application_no." you are notified that your application for ".$app_data->application_title." has been rejected by the Authority on the following grounds:";
																

																	}
																	$reason_for_rejection = $app_data->reason_for_rejection;
																	if($reason_for_rejection == ''){
																		$data = DB::connection('portal_db')->table('wb_rejection_remarks')->where('application_code',$application_code)->first();
																		$reason_for_rejection = $data->remark;
																		$pdf->setCellHeightRatio(2);
																		$pdf->WriteHTML($template, true, false, true, true);
																		$pdf->WriteHTML($reason_for_rejection, true, false, true, true);
																		$pdf->SetFont('times','B',12);
																	}else{
																		
																		$pdf->setCellHeightRatio(2);
																		$pdf->WriteHTML($template, true, false, true, true);
																		$pdf->WriteHTML($reason_for_rejection, true, false, true, true);
																		$pdf->SetFont('times','B',12);
																		
																		$dt =strtotime($app_data->approval_date); //gets dates instance
																		$year = date("Y", $dt);
																		$month = date("m", $dt);
																		$day = date("d", $dt);
																		
																			$pdf->Cell(0, 0,'Dated this '.$day.' day of '.$month.', '.$year, 0, 1, '', 0, '', 3);

																				$startY = $pdf->GetY();
																				$startX =$pdf->GetX();
																				$signiture = getcwd() . '/backend/resources/templates/signatures_uploads/dg_sinatory.png';
																				$pdf->Image($signiture,$startX+75,$startY-7,30,12);
																				$pdf->Cell(0, 0, '___________________________',0,1,'C');
																				$pdf->Cell(0, 0, 'AG. Director-General',0,1,'C');
																	}
																	
																	
																			$pdf->Output('Letter of Rejection '.$application_no.'.pdf');
																			
																}catch (\Exception $exception) {
																	$res = sys_error_handler($exception->getMessage(), 2, debug_backtrace(DEBUG_BACKTRACE_IGNORE_ARGS, 1),explode('\\', __CLASS__), \Auth::user()->id);
											
															} catch (\Throwable $throwable) {
																	$res = sys_error_handler($throwable->getMessage(), 2, debug_backtrace(DEBUG_BACKTRACE_IGNORE_ARGS, 1),explode('\\', __CLASS__), \Auth::user()->id);
															}
															return response()->json($res);									
																	
}
	function getCertificateRegistrationConditions($row,$pdf){
		$module_id = $row->module_id;
		$section_id = $row->section_id;
		if($module_id ==1){
			$where = array('module_id'=>$module_id, 'section_id'=>$section_id);
		
		}
		else{
			$where = array('module_id'=>$module_id, 'section_id'=>$section_id);
		
		}
		
		$records = DB::table('par_certificate_conditions')->where($where)->orderBy('order_no')->get();
			
		if($records){
			
			foreach($records as $rec){
				
					$pdf->Cell(8,2,$rec->order_no.'. ',0,0);
					$pdf->MultiCell(0,5,$rec->certificate_conditions." .\n",0,'J',0,1);
				
			}
			
		}
	}
	function getCertificateSignatoryDetail($record ,$pdf){
		
			$pdf->ln();
								$startY = $pdf->GetY();
								$startX =$pdf->GetX();
								
								
								$director_details = getPermitSignatoryDetails();
										$dg_signatory = $director_details->director_id;
										$director = $director_details->director;
										$is_acting_director = $director_details->is_acting_director;
										
										$approved_by = $record->permit_signatory;
										$permit_signatoryname = $record->permit_signatoryname;
										
										if($dg_signatory != $approved_by){
											$signatory = $approved_by;
										}
										else{
											$signatory = $dg_signatory;
										}
										//permit_approval permit_signatory 
										$signature = getUserSignatureDetails($signatory);
										
										$signature = getcwd() . '/backend/resources/templates/signatures_uploads/'.$signature;
										$pdf->Image($signature,$startX+6,$startY-8,30,12);
										
										 $pdf->Cell(0,8,'...............................................................', 0,1,'');
									
										$title = "Director-General";
										if($dg_signatory != $approved_by){
											$title = 'Acting '.$title;
										}else{
											$permit_signatoryname = $director;
											if($is_acting_director ==1){
												$title = 'Acting '.$title;
											}
											
										}
										$pdf->Cell(0,8,'SIGNATURE', 0,1,'');
										//$pdf->Cell(0,8,strtoupper($permit_signatoryname), 0,1,'');
										// $pdf->Cell(0,8,$title, 0,0,'');

		
	}
	
public function medicinesProductRegistration($application_code,$row){
		try{
			
						
						$is_provisional =0;
						
						if($row){
							if($row->recommendation_id == 2){
								$is_provisional =1;
							}
							$org_info = getOrganisationInfo();
								
								$pdf = new PdfProvider();
								$this->getCertificateHeader($pdf,'');
								$pdf->SetLineWidth(0.4);
								$pdf->Rect(3,3,204,285);
								$logo = getcwd() . '/resources/images/org-logo.jpg';
								$pdf->SetFont('times','B',9);
								$pdf->Cell(0,1,'',0,1);
								
								
								$pdf->Cell(0,21,'',0,1);
								
								$pdf->Cell(0,5,$row->certificate_title,0,1,'C');
								$pdf->SetFont('times','B',10);
								$pdf->ln();
								$act_statement = "Made under Law No. 003/2018 of 09/02/2018 establishing the Rwanda FDA and determining its mission, organization and functioning in his article 3 and article 8 and regulation No. CBD/TRG/010. The Authority here issues.\n";
								
								$pdf->MultiCell(0,5,$act_statement,0,'J',0,1);
							
								$pdf->SetFont('times','B',10);
								$pdf->Cell(0,3,'',0,1);
								
								$pdf->SetFont('times','',10);
									
                                if( $is_provisional == 1){
                                   // $pdf->Cell(70,8,0,0);
									$pdf->MultiCell(70,8,'Provisional registration number of the medicine',0,'',0,0);
                                }
                                else{
                                    $pdf->Cell(70,8,'Registration number:',0,0);
								
                                }
								$data = "Product Registration: Certificate No:".$row->certificate_no."; Brand Name:".$row->brandName.";Expiry Date:".formatDate($row->expiry_date);
								 $styleQR = array('border' => false, 'padding' => 0, 'fgcolor' => array(0, 0, 0), 'bgcolor' => false);
								// QRCODE,H : QR-CODE Best error correction
								
								$pdf->write2DBarcode($data, 'QRCODE,H', 178, 28, 16, 16);
							   
								$pdf->SetFont('times','B',10);
								$pdf->Cell(100,8,$row->certificate_no,0,1);
								//$pdf->Cell(0,1,'',0,2);
								$pdf->SetFont('times','',10);
								
								//Brand Name
								$pdf->MultiCell(0,8,"This is to certify that the medicine described below has been registered in Rwanda subject to conditions indicated at the back of the this certificate:\n",0,'J',0,1);
							
								$pdf->SetFont('times','',10);
								
								//$pdf->Cell(70,10,0,0,'L');
								$pdf->MultiCell(70,8,'Trade name of the medicine:',0,'',0,0);
								$pdf->SetFont('times','B',10);
								
								$pdf->MultiCell(0,8,strtoupper($row->brandName),0,'',0,1);
								//$pdf->Cell(100,8,strtoupper($brandName),0,1,'L'); //Todo: Add Dosage Form
								
								$pdf->SetFont('times','',10);
								
								$pdf->MultiCell(70,12,'Name of the Active immunogenic ingredient(s) and Strength:',0,'',0,0);
								
								 $ingred_rows = DB::table('tra_product_ingredients as t1')
									->select('t1.*', 't6.name as reason_for_inclusion', 't2.name as ingredient_specification', 't3.name as si_unit', 't4.name as ingredient_name', 't5.name as ingredient_type')
									->leftJoin('par_specification_types as t2', 't1.specification_type_id', '=', 't2.id')
									->leftJoin('par_si_units as t3', 't1.ingredientssi_unit_id', '=', 't3.id')
									->leftJoin('par_ingredients_details as t4', 't1.ingredient_id', '=', 't4.id')
									->leftJoin('par_ingredients_types as t5', 't1.ingredient_type_id', '=', 't5.id')
									->leftJoin('par_inclusions_reasons as t6', 't1.inclusion_reason_id', '=', 't6.id')
									->where(array('t1.product_id' => $row->product_id, 'is_active_reason'=>1))
									->get();			
								
								if($ingred_rows){
									$pdf->SetFont('times','I',10);
									foreach($ingred_rows as $ingred_row){
										
										$ingr_name=$ingred_row->ingredient_name;
										$strength=$ingred_row->strength;
										$pdf->SetFont('times','B',10);
										$pdf->MultiCell(0,5,strtoupper($ingr_name).'  '.strtoupper($strength).' '.strtoupper($ingred_row->si_unit),0,'',0,1);
										$pdf->Cell(70,5,'',0,0,'L');
										
									}
									
								}else{
									$ingr_name='';
									$proportion='';
									$strength='';
									$specification_id=0;
								}
								
								$pdf->ln();
								$pdf->SetFont('times','',10);
								$pdf->MultiCell(70,8,'Indication:',0,'',0,0);
								$pdf->SetFont('times','B',10);
								
									$pdf->MultiCell(0,8,strtoupper($row->indication),0,'J',0,1);
								$pdf->SetFont('times','',10);
								
								$pdf->MultiCell(70,8,'Dosage Form and appearance:',0,'',0,0);
								$pdf->SetFont('times','B',10);
						
								$pdf->MultiCell(0,12,strtoupper($row->dosage_form).' '.strtoupper($row->physical_description),0,'J',0,1);
								$pdf->SetFont('times','',10);
								$pdf->SetFont('times','',10);
								$pdf->MultiCell(69,10,'Pack size and Packaging type:',0,'',0,0);
								//$pdf->Cell(70,5,'',0,0,'L');
								
								$pdf->SetFont('times','B',10);
								$packaging = '';
											$container_name = '';
											$retail_packaging_size = '';
								$packaging_data = DB::table('tra_product_packaging as t1')
											->select(DB::raw("t1.*, t2.name as container_type, t3.name as container_name, t4.name as container_material, t5.name as closure_materials, t4.name as container_material, t5.name as closure_material, t6.name as seal_type, t7.name as packaging_units, CONCAT_WS('X',retail_packaging_size,retail_packaging_size1,retail_packaging_size2,retail_packaging_size3,retail_packaging_size4) as retail_packaging"))
											->leftJoin('par_containers_types as t2', 't1.container_type_id', '=', 't2.id')
											->leftJoin('par_containers as t3', 't1.container_id', '=', 't3.id')
											->leftJoin('par_containers_materials as t4', 't1.container_material_id', '=', 't4.id')
											->leftJoin('par_closure_materials as t5', 't1.closure_material_id', '=', 't5.id')
											->leftJoin('par_seal_types as t6', 't1.seal_type_id', '=', 't6.id')
											->leftJoin('par_packaging_units as t7', 't1.packaging_units_id', '=', 't7.id')
											->where(array('t1.product_id' => $row->product_id))
											->get();
								
								if($packaging_data->count() >0){
								$i = 1;
									foreach($packaging_data as $packaging_rec){
										
											$container_material = $packaging_rec->container_material;
											$container_name = $packaging_rec->container_name;
											
											$retail_packaging_size = $packaging_rec->retail_packaging;
											
											$product_unit = $packaging_rec->unit_pack;		
											if($i != 1){
												$pdf->Cell(69,5,'',0,0);
											}									
											if($product_unit == ''){
											
													$pdf->MultiCell(0,5,strtoupper($container_material).' '.strtoupper($container_name) .' OF '.strtoupper($retail_packaging_size),0,'',0,1);
											}
											else{
												
													$pdf->MultiCell(0,5,strtoupper($container_material).' '.strtoupper($container_name) .' OF '.strtoupper($retail_packaging_size).' X '.strtoupper($product_unit),0,'',0,1);													
																							
											}
											
											$i++;		
									
									}
											
								
								}
								else{
									
											$pdf->MultiCell(0,10,'',0,'',0,1);
											
								}
								$pdf->SetFont('times','',10);
								$pdf->SetFont('times','',10);
								$pdf->MultiCell(70,8,'Shelf life of medicine in months and Storage statement:',0,'',0,0); ;
								
								$pdf->SetFont('times','B',10);
								$pdf->MultiCell(0,8,strtoupper($row->shelf_life).', '.strtoupper(html_entity_decode(($row->storage_condition))),0,'',0,1); ;
								
								
								$pdf->SetFont('times','',10);
								$pdf->Cell(70,8,'Distribution category:',0,0,'L');
								$pdf->SetFont('times','B',10);
								$pdf->Cell(100,8,strtoupper($row->distribution_category),0,1,'L'); 
								
								$pdf->SetFont('times','',10);
								//$pdf->Cell(0,1,'',0,1);
								
								$pdf->MultiCell(70,10,'Name of marketing authorization holder:',0,'',0,0);
								
								$pdf->SetFont('times','B',10);
								$pdf->MultiCell(0,10,strtoupper($row->trader_name),0,'',0,1);
								//$pdf->Cell(100,12,ucwords($applicantName),0,1,'L'); 
								//$pdf->Cell(0,1,'',0,1);
								//Manufacturer
								 $manrow = DB::table('tra_product_manufacturers as t1')
									->select('t1.*', 't2.email_address','t1.id as manufacturer_id', 't2.physical_address', 't2.name as manufacturer_name','t2.postal_address', 't3.name as country_name', 't4.name as region_name', 't5.name as district_name')
									->join('tra_manufacturers_information as t2', 't1.manufacturer_id', '=', 't2.id')
									->join('par_countries as t3', 't2.country_id', '=', 't3.id')
									->leftJoin('par_regions as t4', 't2.region_id', '=', 't4.id')
									->leftJoin('par_districts as t5', 't2.district_id', '=', 't5.id')
									->leftJoin('par_manufacturing_roles as t6', 't1.manufacturer_role_id', '=', 't6.id')
									->where(array('t1.product_id' => $row->product_id, 'manufacturer_type_id' => 1))
									->first();
									
									$manufacturer_name='';
									$man_postal_address='';
									$man_physical_address='';
									$man_countryName='';
									$man_districtName='';
									$man_regionName = '';
									
								if($manrow){
									$manufacturer_name=$manrow->manufacturer_name;
									$man_postal_address=$manrow->postal_address;
									$man_physical_address=$manrow->physical_address;
									
									$man_countryName= $manrow->country_name;
									$man_regionName = $manrow->region_name;
								}
								
								//Manufacturer sql 
								$pdf->SetFont('times','',10);
								
								$pdf->MultiCell(70,10,'Name and Address of the Manufacturer:',0,'',0,0);
								$pdf->SetFont('times','B',10);
								$pdf->MultiCell(0,5,strtoupper($manufacturer_name),0,'',0,1);
								
								$pdf->SetFont('times','',10);
								$pdf->Cell(70,5,'',0,0,'L');
								$pdf->SetFont('times','B',10);
								$pdf->MultiCell(0,5,strtoupper($man_postal_address),0,'',0,1);
								$pdf->Cell(70,5,'',0,0,'L');
								$pdf->SetFont('times','B',10);
								$pdf->MultiCell(0,5,strtoupper($man_physical_address),0,'L');
								
								if($man_regionName!=''){
									$pdf->Cell(70,5,'',0,0,'L');
									$pdf->SetFont('times','B',10);
									$pdf->Cell(100,5,strtoupper($man_regionName),0,1,'L'); 
								}
								$pdf->Cell(70,5,'',0,0,'L');
								$pdf->SetFont('times','B',10);
								$pdf->Cell(100,5,strtoupper($man_countryName),0,1,'L'); 
								 
								$pdf->SetFont('times','',10);$pdf->MultiCell(70,8,'Name of Local Technical Representative:',0,'',0,0);
								
								
								$pdf->SetFont('times','B',10);
								$pdf->MultiCell(0,8,strtoupper($row->localAgentName),0,'',0,1);
								//$pdf->Cell(100,8,strtoupper($localAgentName),0,1,'L'); 
								
								$pdf->SetFont('times','',10);
								//$pdf->Cell(0,1,'',0,1);
								$pdf->Cell(70,8,'Issued on:',0,0,'L');
								$pdf->SetFont('times','B',10);
								$pdf->Cell(100,8,ucwords(date('F d, Y ',strtotime($row->certificate_issue_date))),0,1,'L'); 
								
								
								$pdf->SetFont('times','',10);
								//$pdf->Cell(0,1,'',0,1);
								$pdf->Cell(70,8,'Expires on:',0,0,'L');
								$pdf->SetFont('times','B',10);
								$pdf->Cell(100,8,ucwords(date('F d, Y ',strtotime($row->expiry_date))),0,1,'L'); 
								//$pdf->Cell(0,1,'',0,1);
								$pdf->Cell(0,2,'',0,1);
								$permit_signitory = '';
								$title= 'ACTING';
								$title= '';
								$approved_by = '';
								
								
								
								$pdf->Cell(0,2,'',0,1);
								$permit_signitory = '';
								$title= 'ACTING';
								$title= '';
								$approved_by = '';
								
								$this->getCertificateSignatoryDetail($row,$pdf);
								
								$pdf->AddPage();
								$pdf->SetFont('times','B',9);
								
								
								$pdf->Cell(0,5,'Conditions of Registration:',0,1);
								$pdf->SetFont('times','',11);
								$pdf->Cell(0,2,'',0,1);
								
								$this->getCertificateRegistrationConditions($row,$pdf);
								
								$pdf->Output();
						}	
							
								
			
			
		} catch (\Exception $exception) {
				//DB::rollBack();
				$res = array(
					'success' => false,
					'message' => $exception->getMessage()
				);
			} catch (\Throwable $throwable) {
				//DB::rollBack();
				$res = array(
					'success' => false,
					'message' => $throwable->getMessage()
				);
			}
			
		//	
        return response()->json($res);
		
	}
	public function printClinicalTrialCertificate($application_code,$application_id){
		
		try{
				$approvalGrant = DB::table('tra_approval_recommendations')->where('application_code', $application_code)->first();
			if(!$approvalGrant){
				echo "The application has not been approved, contact the system administration.";
				exit();
			}
			if($approvalGrant->decision_id == 1){
			 
							$record = DB::table('tra_clinical_trial_applications as t2')
					->join('wb_trader_account as t3', 't2.applicant_id', '=', 't3.id')
					->leftJoin('clinical_trial_personnel as t4', 't2.sponsor_id', '=', 't4.id')
					->leftJoin('clinical_trial_personnel as t5', 't2.investigator_id', '=', 't5.id')
									->join('tra_approval_recommendations as t6', 't2.application_code', '=', 't6.application_code')
									->leftJoin('par_countries as t7', 't4.country_id', '=', 't7.id')
									->leftJoin('par_regions as t8', 't4.region_id', '=', 't7.id')
									->leftJoin('users as t17', 't6.permit_signatory', '=', 't17.id')
					->select(DB::raw("t2.*,t2.id as previous_id,concat(decrypt(t17.first_name),' ',decrypt(t17.last_name)) as permit_signatoryname,	 t6.permit_signatory,t6.permit_no,t3.name as applicant_name,t4.name as sponsor,t5.name as investigator,
						t3.id as applicant_id, t3.name as applicant_name, t3.contact_person, t3.tin_no,t2.reference_no,t2.*,t6.expiry_date as regexpiry_date,t6.approval_date as regcertificate_issue_date, t6.certificate_no as registration_no,t7.name as sponsor_country, t7.name as sponsor_region,
						t3.country_id as app_country_id, t3.region_id as app_region_id, t3.district_id as app_district_id,t2.id as application_id,
						t3.physical_address as app_physical_address, t3.postal_address as app_postal_address,t4.postal_address as sponsor_address ,
											t3.telephone_no as app_telephone,t3.fax as app_fax, t3.email as app_email, t3.website as app_website"))
											->where('t2.application_code',$application_code)
											->first();
							if($record){
								$row = $record;
								$principal_investigator= $row->investigator;
								$principal_investigator= $row->investigator;
								$application_id = $row->application_id;
								$reference_no = $row->reference_no;	$protocol_no = $row->protocol_no;
								$data = "Clincial Trial Authorisation: Permit No:".$row->registration_no."; Protocol No:".$row->protocol_no.";Issued Date:".formatDate($row->regcertificate_issue_date);
								$styleQR = array('border' => false, 'padding' => 0, 'fgcolor' => array(0, 0, 0), 'bgcolor' => false);
							
											$org_info = getOrganisationInfo();
												
								$pdf = new PdfProvider();
								$this->getCertificateHeader($pdf, '');
											
								$this->funcGenerateQrCode($record,$pdf);
												
											
											$logo = getcwd() . '/resources/images/org-logo.jpg';
											$pdf->SetFont('times','B',9);
											$pdf->Cell(0,1,'',0,1);
											$pdf->Image($logo, 91, 15, 31, 36);
											
										
										$pdf->Cell(0,25,'',0,1);
											
										$pdf->SetFont('','B',12);
									
										$pdf->Cell(0,5,'CLINICAL TRIAL APPROVAL CERTIFICATE',0,1,'C');
										$pdf->SetFont('','BI',9);
										$pdf->Cell(0,5,'(Made under section 61(2)(b)(ii) of RWANDA FOOD AND DRUGS AUTHORITY Act, Cap 219)',0,1,'C');
										$pdf->MultiCell(0,5,'(Made under law No. 003/2018 of 09/02/2018 establishing the Rwanda FDA and determining its mission, organization, and functioning in its article 8, paragraph 7and article 9, paragraph 2)',0,'C',0,1);
								
										$pdf->Cell(0,5,'',0,1);
										$pdf->SetFont('','B',11);
										$pdf->Cell(0,5,'Clinical Trial Approval Certificate No:'.strtoupper($row->registration_no),0,1,'');
										$pdf->Cell(0,5,'',0,1);
									$pdf->SetFont('','',11);
										$pdf->MultiCell(0,5,"This is to certify that the clinical trial described below has been approved in Rwanda subject to conditions indicated in this certificate.:\n",0,'J',0,1);
												
										$pdf->SetFont('','',11);
										$pdf->SetLineWidth(0.2);
										//get Study sites 
										$study_siterec = DB::table('study_sites as t1')
										->join('par_countries as t2', 't1.country_id', '=', 't2.id')
										->leftJoin('par_regions as t3', 't1.region_id', '=', 't3.id')
										->join('clinical_trial_sites as t4', 't1.id', '=', 't4.study_site_id')
									
										->select('t1.*','t1.name as study_site_name', 't2.name as country_name', 't3.name as region_name')
										->where('t4.application_id',$application_id);
										$total_record = $study_siterec->count();
										$study_siterec = 	$study_siterec->get();
										$study_sites= '';
															
															$i = 1;
															if($study_siterec){
																
																foreach($study_siterec as $rows){
																	if( $total_record == 1){
																		$study_sites.= $rows->study_site_name." ".$rows->physical_address." ".$rows->region_name." "; 
																
																	}
																	else if($i == $total_record){
																		$study_sites.= " and ".$rows->study_site_name." ".$rows->physical_address." ".$rows->region_name." "; 
																
																	}
																	else if(($i+1) == $total_record){
																		$study_sites.=$rows->study_site_name." ".$rows->physical_address." ".$rows->region_name." "; 
																
																	}
																	else{
																		$study_sites.= $rows->study_site_name." ".$rows->physical_address." ".$rows->region_name.", "; 
																
																	}
																			$i++;
																}
															
															}
										
										$pdf->Cell(0,5,'',0,1);
										$pdf->SetFont('','',11);
										$pdf->Cell(60,5,'Protocol Title: ',0,0);
										$pdf->SetFont('','B',11);
										$pdf->MultiCell(0,5,strtoupper($row->study_title),0,'L');
										$pdf->Cell(0,5,'',0,1);
										$pdf->SetFont('','',11);
										$pdf->setCellHeightRatio(1.8);
										//$date_of_protocol = date('jS F, Y',strtotime($pdf->date_of_protocol));
										$pdf->Cell(60,5,'Protocol Number and version: ',0,0);
										$pdf->WriteHTML('<span style="text-align:justify;"><b>'.strtoupper($row->protocol_no).'</b> <b>'.strtoupper($row->version_no).'</b></span>', true, 0, true, true,'');
									
										$pdf->SetFont('','',11);
										
										$pdf->Cell(60,7,'Name of the Investigational product (s):',0,1);
										$pdf->MultiCell(90,6,'Investigational Product(s)/Intervention (s)',1,'',0,0);
										
										$pdf->MultiCell(0,6,'Comparator (s)',1,'',0,1);
										
										$prod_records = DB::table("clinical_trial_products")
																->select("*")
																->where(array('application_id'=>$application_id))
																->get();
										$comparator_products = '';							
										$investigational_products = '';							
										if($prod_records){
												foreach($prod_records as $prod_record){
														$brand_name = $prod_record->brand_name;
														$product_category_id = $prod_record->product_category_id;
														if($product_category_id == 1){
															$comparator_products = $brand_name.', ';
														}else if($product_category_id == 2){
															$investigational_products = $brand_name.', ';
														}
														
													
												}
										}
										$pdf->SetFont('','B',11);
										$pdf->MultiCell(90,6,strtoupper(trim($investigational_products, ', ')),1,'',0,0);
										
										$pdf->MultiCell(0,6,strtoupper(trim($comparator_products ,', ')),1,'',0,1);
										
										$pdf->SetFont('','',11);
										$pdf->Cell(60,5,'Study site(s):',0,0);
										$pdf->SetFont('','B',11);
										$pdf->MultiCell(0,5,strtoupper($study_sites),0,'',0,1);
										
										
										$pdf->SetFont('','',11);
										$pdf->Cell(60,5,'Name of the Principal Investigator(s).',0,0);
										$pdf->SetFont('','B',11);
										$pdf->MultiCell(0,5,strtoupper($principal_investigator),0,'',0,1);
										$pdf->SetFont('','',11);
										$pdf->MultiCell(60,5,'Sponsor’s name:  ',0,'',0,0);
										$pdf->MultiCell(0,5,strtoupper($row->sponsor),0,'',0,1);
										$pdf->SetFont('','',11);
										$pdf->Cell(60,5,'Issued on:',0,0);
										$pdf->SetFont('','B',11);
										
										$approval_date = date('j\<\s\u\p\>S\<\/\s\u\p\> F Y', strtotime($row->regcertificate_issue_date));
										
										$pdf->SetFont('','',11);
										
										$pdf->WriteHTML('<b>'.strtoupper($approval_date),true,0,true,true);
										
										$expiry_date = date('j\<\s\u\p\>S\<\/\s\u\p\> F Y', strtotime($row->regexpiry_date));
										
										$pdf->SetFont('','',11);
										$pdf->Cell(60,5,'Expires on:',0,0);
										$pdf->WriteHTML('<b>'.strtoupper($expiry_date),true,0,true,true);
										$pdf->ln();
										$permit_signitory = '';
										$title= 'ACTING';
										$title= '';
										$approved_by = '';
														
										$this->getCertificateSignatoryDetail($record,$pdf);
										
										$pdf->AddPage();
										
												$pdf->SetFont('','BU',13);
												$pdf->Cell(0,5,'Key Conditions for compliance ',0,1);
															
										$pdf->SetFont('times','',11);
										
										$this->getCertificateRegistrationConditions($row,$pdf);
										
										
							}
							else{
									$pdf->SetFont('','B',12);
									$pdf->Cell(0,5,'No Record Found',0,1);
							
							}
								 $pdf->Output('Clinical trial Certificate '.date('Y').date('m').date('d').date('i').date('s').'.pdf','I');
							
	
			}else{
				return "Setup rejection letter";
			}
			
			
		}catch (\Exception $exception) {
				//DB::rollBack();
				$res = array(
					'success' => false,
					'message' => $exception->getMessage()
				);
			} catch (\Throwable $throwable) {
				//DB::rollBack();
				$res = array(
					'success' => false,
					'message' => $throwable->getMessage()
				);
			}
			
			//
        return response()->json($res);
		
		
	}
	function printWaterMark($pdf,$permit_watermark){
		$pdf->setPage( 1 );

		// Get the page width/height
		$myPageWidth = $pdf->getPageWidth();
		$myPageHeight = $pdf->getPageHeight();

		// Find the middle of the page and adjust.
		$myX = ( $myPageWidth / 2 ) - 75;
		$myY = ( $myPageHeight / 2 ) + 25;

		// Set the transparency of the text to really light
		$pdf->SetAlpha(0.09);

		// Rotate 45 degrees and write the watermarking text
		$pdf->StartTransform();
		$pdf->Rotate(45, $myX, $myY);
		$pdf->SetFont("courier", "", 80);
		$pdf->Text($myX, $myY,$permit_watermark);
		$pdf->StopTransform();

		// Reset the transparency to default
		$pdf->SetAlpha(1);
		
	}
	public function printExportLicense($application_code,$record,$permit_watermark,$is_preview){
		try{
				$record = DB::table('tra_importexport_applications as t1')
						->join('sub_modules as t2','t1.sub_module_id','t2.id')
						->leftJoin('wb_trader_account as t3','t1.applicant_id', 't3.id')
						->leftJoin('par_countries as t4', 't3.country_id', 't4.id')
						->leftJoin('par_regions as t5', 't3.region_id', 't5.id')
						->leftJoin('par_ports_information as t6', 't1.port_id', 't6.id')
						->leftJoin('tra_managerpermits_review as t7', 't1.application_code', 't7.application_code')
						->leftJoin('users as t8', 't7.permit_signatory', 't8.id')
						->leftJoin('tra_permitsenderreceiver_data as t9','t1.sender_receiver_id', 't9.id')
						->leftJoin('par_countries as t10', 't9.country_id', 't10.id')
						->leftJoin('par_regions as t11', 't9.region_id', 't11.id')
						->leftJoin('par_modesof_transport as t12', 't1.mode_oftransport_id', 't12.id')
						->leftJoin('tra_managerpermits_review as t13', 't1.application_code', 't13.application_code')
						->leftJoin('tra_consignee_data as t14', 't1.consignee_id', 't14.id')
						->leftJoin('par_sections as t15', 't1.section_id', 't15.id')
						->leftJoin('tra_premises as t16', 't1.premise_id', 't16.id')
						->leftJoin('par_sections as t17', 't1.section_id', 't17.id')
						->select('t2.title','t1.premise_id', 't13.expiry_date as permit_expiry_date','t17.name as permit_productscategory', 't3.physical_address as applicant_physical_address', 't3.postal_address as applicant_postal_address', 't15.name  as product_category','t16.*','t2.title as permit_title','t13.permit_no','t14.name as consignee_name', 't1.sub_module_id', 't1.*','t16.name as premise_name','t3.name as applicant_name','t2.action_title','t6.name as port_entry', 't3.*', 't4.name as country_name', 't5.name as region_name','t7.permit_signatory', 't7.approval_date', DB::raw("concat(decrypt(t8.first_name),' ',decrypt(t8.last_name)) as permit_signatoryname, t9.name as suppler_name, t9.physical_address as suppler_address,'t7.expiry_date', t10.name as supplier_country, t11.name as supplier_region, t9.postal_address as supplier_postal_address, t12.name as mode_of_transport"))
						->where('t1.application_code',$application_code)
						->first();

						$sub_module_id = $record->sub_module_id;
						$permit_title = $record->permit_title;
						$action_title = $record->action_title;
						$consignee_name  = $record->consignee_name ;
						$approval_date = '';
						if($record->approval_date != ''){
								$approval_date = $record->approval_date;
						}
						if($record){
							$org_info = getOrganisationInfo();
												
								$pdf = new PdfPermitProvider();
								$this->getImpPermitCertificateHeader($pdf,$record,$permit_title);
								
								$pdf->SetFont('','',10);
								 $pdf->Cell(0,7,'Import License No: '.$record->permit_no,0,1);
								 $pdf->ln();
								 if(validateIsNumeric($record->premise_id)){
									 
									 $pdf->Cell(0,7,'Name of Importer: '.$record->premise_name,0,1);
									 $pdf->Cell(0,7,'TIN: '.$record->tpin_no,0,1);
									 $pdf->Cell(0,7,'Premise No: '.$record->premise_reg_no,0,1);
									 $pdf->Cell(0,7,'Postal Address: '.$record->postal_address,0,1);
									 $pdf->Cell(0,7,'Physical Location: '.$record->physical_address,0,1);
									 
									 
								 }
								 else{
									 
									$pdf->Cell(0,7,'Name of Importer: '.$record->applicant_name,0,1);
									 $pdf->Cell(0,7,'TIN: '.$record->tin_no,0,1);
									 //$pdf->Cell(0,7,'Premise No: '.$record->permit_no,0,1);
									 $pdf->Cell(0,7,'Postal Address: '.$record->applicant_postal_address,0,1);
									 $pdf->Cell(0,7,'Physical Location: '.$record->applicant_physical_address,0,1);
									  
								 }
								 
								$this->funcImpGenerateQrCode($record,$pdf);
								 $pdf->ln();
								 $startY = $pdf->GetY()-5;
										$startX = $pdf->GetX();
										$pdf->SetLineWidth(0.8);
										$pdf->Line(0+10,$startY,198,$startY);
											$pdf->SetFont('','B',10);
											
								 $pdf->Cell(0,5,'Product Category: '.$record->permit_productscategory,0,1);
								 $pdf->Cell(0,5,'Transport Mean: '.$record->mode_of_transport,0,1);
								 $pdf->Cell(0,5,'Port Of Exit: '.$record->port_entry,0,1);
								 
								$pdf->SetFont('','',10);
								$pdf->setCellHeightRatio(1.8);
									$pdf->ln();
								$pdf->SetFont('','B',9);
								$pdf->SetLineWidth(0.1);
								$pdf->Cell(10,7,'No',1,0);
								$pdf->Cell(35,7,'Product',1,0);
								$pdf->Cell(25,7,'Pack Size',1,0);
								$pdf->Cell(25,7,'Batch/serial #',1,0);
								$pdf->Cell(25,7,'Mgf Date(s)',1,0);
								$pdf->Cell(25,7,'Quantity',1,0);
								$pdf->Cell(25,7,'Unit Value',1,0);
								$pdf->Cell(0,7,'Total Value',1,1);$pdf->SetFont('','',9);
							$prod_rec = DB::table('tra_permits_products as t1')
																		->leftJoin('tra_product_information as t2', 't1.product_id', 't2.id')
																		->leftJoin('par_dosage_forms as t3', 't1.dosage_form_id', 't3.id')
																		->leftJoin('par_packaging_units as t4', 't1.packaging_unit_id', 't4.id')
																		->leftJoin('par_common_names as t5', 't1.common_name_id', 't5.id')
																		->leftJoin('par_si_units as t6', 't1.unitpack_unit_id', 't6.id')
																		->leftJoin('par_currencies as t7', 't1.currency_id', 't7.id')
																		->leftJoin('tra_manufacturers_information as t8', 't1.manufacturer_id', 't8.id')
																		->leftJoin('par_countries as t9', 't1.country_oforigin_id', 't9.id')
																		->select('t1.*','t7.name as currency_name','t8.name as manufacturer_name',  't4.name as packaging_unit','t1.product_strength','t5.name as generic_name','t1.permitcommon_name', 't2.brand_name','t9.name as country_name', 't3.name as dosage_form', 't6.name as si_unit', 't1.unitpack_size', 't1.product_strength')
																		->where(array('application_code'=>$record->application_code))
																		->get();
											$prod_counter = $prod_rec->count();		
								$currency_name = '';											
								$total_amount = 0;											
								if($prod_counter >0){
											$i=1;
									foreach($prod_rec as $rec){
										if(validateIsNumeric($rec->product_id)){
												
												$permit_brandname = $rec->brand_name.' '.$rec->generic_name .' '.$rec->product_strength.'. Manufacturer: '.$rec->manufacturer_name.' Country: '.$rec->country_name;
										}
										else{	
												$permit_brandname = $rec->permitbrand_name.' '.$rec->permitcommon_name .' '.$rec->product_strength.'. Manufacturer: '.$rec->manufacturer_name.' Country: '.$rec->country_name;

										}		
										$amount = $rec->unit_price*$rec->quantity;										
										$packaging_data = $rec->unitpack_size.' '.$rec->si_unit;
										$product_batch_no = $rec->product_batch_no;
										$manufacturing_dates = 'Mgf Date: '.formatDateRpt($rec->product_manufacturing_date).' Exp. Date'.formatDateRpt($rec->product_expiry_date);
											
											$rowcount = max(PDF::getNumLines($permit_brandname, 35),PDF::getNumLines($packaging_data, 25),PDF::getNumLines($packaging_data, 25),PDF::getNumLines($packaging_data, 25));
											
											$pdf->MultiCell(10,5*$rowcount,$i,1,'',0,0);
											$pdf->MultiCell(35,5*$rowcount,$permit_brandname,1,'',0,0);
											$pdf->MultiCell(25,5*$rowcount,$rec->unitpack_size.' '.$rec->si_unit,1,'',0,0);
											
											$pdf->MultiCell(25,5*$rowcount,$product_batch_no,1,'',0,0);
											$pdf->MultiCell(25,5*$rowcount,$manufacturing_dates,1,'',0,0);
											$pdf->MultiCell(25,5*$rowcount,$rec->quantity.' '.$rec->packaging_unit,1,'',0,0);
											$pdf->MultiCell(25,5*$rowcount,($rec->unit_price).' ',1,'',0,0);
											$pdf->MultiCell(0,5*$rowcount,formatMoney($amount).' '.$rec->currency_name,1,'R',0,1);	
													
											$currency_name = $rec->currency_name;
											$total_amount = $total_amount+$amount;
									} 
									$pdf->Cell(145,7,'Total Value:',1,0, 'R');
										$pdf->Cell(0,7,formatMoney($total_amount).' '.$currency_name,1,1, 'R');
								}   $pdf->SetFont('','',10);
								$pdf->ln();
								
								$pdf->Cell(0,5,'Name of the Supplier: '.strtoupper($record->suppler_name),0,1);
									 
									 $pdf->Cell(0,5,'Address: '.$record->postal_address,0,1);
									 $pdf->Cell(0,5,'Physical Location: '.strtoupper($record->suppler_address),0,1);
									 $pdf->Cell(0,5,'Country: '.strtoupper($record->supplier_country),0,1);
								$pdf->ln();
								
								$pdf->WriteHTML("This certificate authorizes the above exporter to export the products specified in Invoice number  <b>".$record->proforma_invoice_no."</b> after complying with the exportation requirements.", true, 0, true, true,'J');
								
								
								
								$pdf->WriteHTML("All consignments to be exported must be inspected at port of exit or at exporter’s premises before being shipped to ensure that they comply with claimed specifications.", true, 0, true, true,'J');
								
								$pdf->Cell(45,8,'This Certficate is valid up to: ',0,0);
								$pdf->SetFont('','B',10);
								$pdf->Cell(0,8,formatDateRpt($record->permit_expiry_date),0,0);
								$pdf->SetFont('','',10);
								
												
								$permit_signitory = '';
								$title= 'ACTING';
								$title= '';
								$approved_by = '';
										if($permit_watermark != ''){
									
									$this->printWaterMark($pdf,$permit_watermark);
								}		
								$this->getCertificateSignatoryDetail($record,$pdf);
									$pdf->Output($permit_title.'.pdf');

						}
					
										
					
		}catch (\Exception $exception) {
				//DB::rollBack();
				$res = array(
					'success' => false,
					'message' => $exception->getMessage()
				);
			} catch (\Throwable $throwable) {
				//DB::rollBack();
				$res = array(
					'success' => false,
					'message' => $throwable->getMessage()
				);
			}
			print_r($res);
			exit();
			//
        return response()->json($res);
		
		
		
		
	}
	public function printImportLicense($application_code,$record,$permit_watermark,$is_preview){
		try{
				$record = DB::table('tra_importexport_applications as t1')
						->join('sub_modules as t2','t1.sub_module_id','t2.id')
						->leftJoin('wb_trader_account as t3','t1.applicant_id', 't3.id')
						->leftJoin('par_countries as t4', 't3.country_id', 't4.id')
						->leftJoin('par_regions as t5', 't3.region_id', 't5.id')
						->leftJoin('par_ports_information as t6', 't1.port_id', 't6.id')
						->leftJoin('tra_managerpermits_review as t7', 't1.application_code', 't7.application_code')
						->leftJoin('users as t8', 't7.permit_signatory', 't8.id')
						->leftJoin('tra_permitsenderreceiver_data as t9','t1.sender_receiver_id', 't9.id')
						->leftJoin('par_countries as t10', 't9.country_id', 't10.id')
						->leftJoin('par_regions as t11', 't9.region_id', 't11.id')
						->leftJoin('par_modesof_transport as t12', 't1.mode_oftransport_id', 't12.id')
						->leftJoin('tra_managerpermits_review as t13', 't1.application_code', 't13.application_code')
						->leftJoin('tra_consignee_data as t14', 't1.consignee_id', 't14.id')
						->leftJoin('par_sections as t15', 't1.section_id', 't15.id')
						->leftJoin('tra_premises as t16', 't1.premise_id', 't16.id')
						->leftJoin('par_sections as t17', 't1.section_id', 't17.id')
						
						->select('t2.title','t1.premise_id','t13.expiry_date as permit_expiry_date','t17.name as permit_productscategory', 't3.physical_address as applicant_physical_address', 't3.postal_address as applicant_postal_address', 't15.name  as product_category','t16.*','t2.title as permit_title','t13.permit_no','t14.name as consignee_name', 't1.sub_module_id', 't1.*','t16.name as premise_name','t3.name as applicant_name','t2.action_title','t6.name as port_entry', 't3.*', 't4.name as country_name', 't5.name as region_name','t7.permit_signatory', 't7.approval_date', DB::raw("concat(decrypt(t8.first_name),' ',decrypt(t8.last_name)) as permit_signatoryname, t9.name as suppler_name, t9.physical_address as suppler_address,'t13.expiry_date', t10.name as supplier_country, t11.name as supplier_region, t9.postal_address as supplier_postal_address, t12.name as mode_of_transport"))
						->where('t1.application_code',$application_code)
						->first();
/*

->where(function ($query) {
							$query->leftJoin('tra_importexport_applications as t19', 't1.reg_importexport_id', 't19.reg_importexport_id')
									->whereIn('t19.sub_module_id', 12);
						})
*/
						$sub_module_id = $record->sub_module_id;
						$permit_title = $record->permit_title;
						$action_title = $record->action_title;
						$consignee_name  = $record->consignee_name ;
						$approval_date = '';
						if($record->approval_date != ''){
								$approval_date = $record->approval_date;
						}
						if($record){
							$org_info = getOrganisationInfo();
												
								$pdf = new PdfPermitProvider();
								$this->getImpPermitCertificateHeader($pdf,$record,$permit_title);
								$pdf->SetFont('','',10);
								 $pdf->Cell(0,7,'Import License No: '.$record->permit_no,0,1);
								 if($record->sub_module_id == 82){
									 
										$pdf->Cell(0,7,'Visa  No: ',0,1);
								 }
								 $pdf->ln();
								 if(validateIsNumeric($record->premise_id)){
									 
									 $pdf->Cell(0,7,'Name of Importer: '.$record->premise_name,0,1);
									 $pdf->Cell(0,7,'TIN: '.$record->tpin_no,0,1);
									 $pdf->Cell(0,7,'Premise No: '.$record->premise_reg_no,0,1);
									 $pdf->Cell(0,7,'Postal Address: '.$record->postal_address,0,1);
									 $pdf->Cell(0,7,'Physical Location: '.$record->physical_address,0,1);
									 
									 
								 }
								 else{
									 
									$pdf->Cell(0,7,'Name of Importer: '.$record->applicant_name,0,1);
									 $pdf->Cell(0,7,'TIN: '.$record->tin_no,0,1);
									 //$pdf->Cell(0,7,'Premise No: '.$record->permit_no,0,1);
									 $pdf->Cell(0,7,'Postal Address: '.$record->applicant_postal_address,0,1);
									 $pdf->Cell(0,7,'Physical Location: '.$record->applicant_physical_address,0,1);
									  
								 }
								 
								$this->funcImpGenerateQrCode($record,$pdf);
								 $pdf->ln();
								 $startY = $pdf->GetY()-5;
										$startX = $pdf->GetX();
										$pdf->SetLineWidth(0.8);
										$pdf->Line(0+10,$startY,198,$startY);
											$pdf->SetFont('','B',10);
											
								 $pdf->Cell(0,5,'Product Category: '.$record->permit_productscategory,0,1);
								 $pdf->Cell(0,5,'Transport Mean: '.$record->mode_of_transport,0,1);
								 $pdf->Cell(0,5,'Port Of Entry: '.$record->port_entry,0,1);
								 
								$pdf->SetFont('','',10);
								$pdf->setCellHeightRatio(1.8);
									$pdf->ln();
								$pdf->SetFont('','B',9);
								$pdf->SetLineWidth(0.1);
								$pdf->Cell(10,7,'No',1,0);
								$pdf->Cell(35,7,'Product',1,0);
								$pdf->Cell(25,7,'Pack Size',1,0);
								$pdf->Cell(25,7,'Batch/serial #',1,0);
								$pdf->Cell(25,7,'Mgf Date(s)',1,0);
								$pdf->Cell(25,7,'Quantity',1,0);
								$pdf->Cell(25,7,'Unit Value',1,0);
								$pdf->Cell(0,7,'Total Value',1,1);$pdf->SetFont('','',9);
							$prod_rec = DB::table('tra_permits_products as t1')
																		->leftJoin('tra_product_information as t2', 't1.product_id', 't2.id')
																		->leftJoin('par_dosage_forms as t3', 't1.dosage_form_id', 't3.id')
																		->leftJoin('par_packaging_units as t4', 't1.packaging_unit_id', 't4.id')
																		->leftJoin('par_common_names as t5', 't1.common_name_id', 't5.id')
																		->leftJoin('par_si_units as t6', 't1.unitpack_unit_id', 't6.id')
																		->leftJoin('par_currencies as t7', 't1.currency_id', 't7.id')
																		->leftJoin('tra_manufacturers_information as t8', 't1.manufacturer_id', 't8.id')
																		->leftJoin('par_countries as t9', 't1.country_oforigin_id', 't9.id')
																		->select('t1.*','t7.name as currency_name','t8.name as manufacturer_name',  't4.name as packaging_unit','t1.product_strength','t5.name as generic_name','t1.permitcommon_name', 't2.brand_name','t9.name as country_name', 't3.name as dosage_form', 't6.name as si_unit', 't1.unitpack_size', 't1.product_strength')
																		->where(array('application_code'=>$record->application_code))
																		->get();
											$prod_counter = $prod_rec->count();		
								$currency_name = '';											
								$total_amount = 0;											
								if($prod_counter >0){
											$i=1;
									foreach($prod_rec as $rec){
										if(validateIsNumeric($rec->product_id)){
												
												$permit_brandname = $rec->brand_name.' '.$rec->generic_name .' '.$rec->product_strength.'. Manufacturer: '.$rec->manufacturer_name.' Country: '.$rec->country_name;
										}
										else{	
												$permit_brandname = $rec->permitbrand_name.' '.$rec->permitcommon_name .' '.$rec->product_strength.'. Manufacturer: '.$rec->manufacturer_name.' Country: '.$rec->country_name;

										}		
										$amount = $rec->unit_price*$rec->quantity;										
										$packaging_data = $rec->unitpack_size.' '.$rec->si_unit;
										$product_batch_no = $rec->product_batch_no;
										$manufacturing_dates = 'Mgf Date: '.formatDateRpt($rec->product_manufacturing_date).' Exp. Date'.formatDateRpt($rec->product_expiry_date);
											
											$rowcount = max(PDF::getNumLines($permit_brandname, 35),PDF::getNumLines($packaging_data, 25),PDF::getNumLines($packaging_data, 25),PDF::getNumLines($packaging_data, 25));
											
											$pdf->MultiCell(10,5*$rowcount,$i,1,'',0,0);
											$pdf->MultiCell(35,5*$rowcount,$permit_brandname,1,'',0,0);
											$pdf->MultiCell(25,5*$rowcount,$rec->unitpack_size.' '.$rec->si_unit,1,'',0,0);
											
											$pdf->MultiCell(25,5*$rowcount,$product_batch_no,1,'',0,0);
											$pdf->MultiCell(25,5*$rowcount,$manufacturing_dates,1,'',0,0);
											$pdf->MultiCell(25,5*$rowcount,$rec->quantity.' '.$rec->packaging_unit,1,'',0,0);
											$pdf->MultiCell(25,5*$rowcount,($rec->unit_price).' ',1,'',0,0);
											$pdf->MultiCell(0,5*$rowcount,formatMoney($amount).' '.$rec->currency_name,1,'R',0,1);	
													
											$currency_name = $rec->currency_name;
											$total_amount = $total_amount+$amount;
									} 
									$pdf->Cell(145,7,'Total Value:',1,0, 'R');
										$pdf->Cell(0,7,formatMoney($total_amount).' '.$currency_name,1,1, 'R');
								}   $pdf->SetFont('','',10);
								$pdf->ln();
								
								$pdf->Cell(0,5,'Name of the Supplier: '.strtoupper($record->suppler_name),0,1);
									 
									 $pdf->Cell(0,5,'Address: '.$record->postal_address,0,1);
									 $pdf->Cell(0,5,'Physical Location: '.strtoupper($record->suppler_address),0,1);
									 $pdf->Cell(0,5,'Country: '.strtoupper($record->supplier_country),0,1);
								$pdf->ln();
								
								$pdf->WriteHTML("This certificate authorizes the above importer to import the products specified in Invoice number <b>".$record->proforma_invoice_no."</b> into the country after complying with the importation requirements.", true, 0, true, true,'J');
								
								
								
								$pdf->WriteHTML("All the imported consignments must be inspected at port of entry or at importer’s premises at arrival before being used to ensure that they comply with claimed specifications.", true, 0, true, true,'J');
								
								$pdf->Cell(45,8,'This Certficate is valid up to: ',0,0);
								$pdf->SetFont('','B',10);
								$pdf->Cell(0,8,formatDateRpt($record->permit_expiry_date),0,0);
								$pdf->SetFont('','',10);
										
								$permit_signitory = '';
								$title= 'ACTING';
								$title= '';
								$approved_by = '';
											if($permit_watermark != ''){
									
									$this->printWaterMark($pdf,$permit_watermark);
								}	
								$this->getCertificateSignatoryDetail($record,$pdf);
									$pdf->Output($permit_title.'.pdf');

						}
					
										
					
		}catch (\Exception $exception) {
				//DB::rollBack();
				$res = array(
					'success' => false,
					'message' => $exception->getMessage()
				);
			} catch (\Throwable $throwable) {
				//DB::rollBack();
				$res = array(
					'success' => false,
					'message' => $throwable->getMessage()
				);
			}
			print_r($res);
			exit();
			//
        return response()->json($res);
		
		
		
	}
	public function printImportExportvisa($application_code,$record,$permit_watermark,$is_preview){
		try{
				$record = DB::table('tra_importexport_applications as t1')
						->join('sub_modules as t2','t1.sub_module_id','t2.id')
						->leftJoin('wb_trader_account as t3','t1.applicant_id', 't3.id')
						->leftJoin('par_countries as t4', 't3.country_id', 't4.id')
						->leftJoin('par_regions as t5', 't3.region_id', 't5.id')
						->leftJoin('par_ports_information as t6', 't1.port_id', 't6.id')
						->leftJoin('tra_managerpermits_review as t7', 't1.application_code', 't7.application_code')
						->leftJoin('users as t8', 't7.permit_signatory', 't8.id')
						->leftJoin('tra_permitsenderreceiver_data as t9','t1.sender_receiver_id', 't9.id')
						->leftJoin('par_countries as t10', 't9.country_id', 't10.id')
						->leftJoin('par_regions as t11', 't9.region_id', 't11.id')
						->leftJoin('par_modesof_transport as t12', 't1.mode_oftransport_id', 't12.id')
						->leftJoin('tra_managerpermits_review as t13', 't1.application_code', 't13.application_code')
						->leftJoin('tra_consignee_data as t14', 't1.consignee_id', 't14.id')
						->leftJoin('par_sections as t15', 't1.section_id', 't15.id')
						->leftJoin('tra_premises as t16', 't1.premise_id', 't16.id')
						->leftJoin('par_sections as t17', 't1.section_id', 't17.id')
						->select('t2.title','t1.premise_id','t13.expiry_date as permit_expiry_date','t17.name as permit_productscategory', 't3.physical_address as applicant_physical_address', 't3.postal_address as applicant_postal_address', 't15.name  as product_category','t16.*','t2.title as permit_title','t13.permit_no','t14.name as consignee_name', 't1.sub_module_id', 't1.*','t16.name as premise_name','t3.name as applicant_name','t2.action_title','t6.name as port_entry', 't3.*', 't4.name as country_name', 't5.name as region_name','t7.permit_signatory', 't7.approval_date', DB::raw("concat(decrypt(t8.first_name),' ',decrypt(t8.last_name)) as permit_signatoryname, t9.name as suppler_name, t9.physical_address as suppler_address, t10.name as supplier_country, t11.name as supplier_region, t9.postal_address as supplier_postal_address, t12.name as mode_of_transport"))
						->where('t1.application_code',$application_code)
						->first();
						$sub_module_id = $record->sub_module_id;
						$permit_title = $record->permit_title;
						$action_title = $record->action_title;
						$consignee_name  = $record->consignee_name ;
						$approval_date = '';
						if($record->approval_date != ''){
								$approval_date = $record->approval_date;
						}
						if($record){
														$org_info = getOrganisationInfo();
												
								$pdf = new PdfPermitProvider();
								$this->getImpPermitCertificateHeader($pdf,$record,$permit_title);
								
								$pdf->SetFont('','',10);
								 $pdf->Cell(0,7,'Import Visa No: '.$record->permit_no,0,1);
								 $pdf->ln();
								 if(validateIsNumeric($record->premise_id)){
									 
									 $pdf->Cell(0,7,'Name of Importer: '.$record->premise_name,0,1);
									 $pdf->Cell(0,7,'TIN: '.$record->tpin_no,0,1);
									 $pdf->Cell(0,7,'Premise No: '.$record->premise_reg_no,0,1);
									 $pdf->Cell(0,7,'Postal Address: '.$record->postal_address,0,1);
									 $pdf->Cell(0,7,'Physical Location: '.$record->physical_address,0,1);
									 
									 
								 }
								 else{
									 
									$pdf->Cell(0,7,'Name of Importer: '.$record->applicant_name,0,1);
									 $pdf->Cell(0,7,'TIN: '.$record->tin_no,0,1);
									 //$pdf->Cell(0,7,'Premise No: '.$record->permit_no,0,1);
									 $pdf->Cell(0,7,'Postal Address: '.$record->applicant_postal_address,0,1);
									 $pdf->Cell(0,7,'Physical Location: '.$record->applicant_physical_address,0,1);
									  
								 }
								 
								$this->funcImpGenerateQrCode($record,$pdf);
								 $pdf->ln();
								 $startY = $pdf->GetY()-5;
										$startX = $pdf->GetX();
										$pdf->SetLineWidth(0.8);
										$pdf->Line(0+10,$startY,198,$startY);
											$pdf->SetFont('','B',10);
											
								 $pdf->Cell(0,5,'Product Category: '.$record->permit_productscategory,0,1);
								 
								$pdf->SetFont('','',10);
								$pdf->setCellHeightRatio(1.8);
									$pdf->ln();
								$pdf->SetFont('','B',9);
								$pdf->SetLineWidth(0.1);
								$pdf->Cell(10,7,'No',1,0);
								$pdf->Cell(45,7,'Product',1,0);
								$pdf->Cell(30,7,'Pack Size',1,0);
								//$pdf->Cell(25,7,'Batch/serial #',1,0);
								//$pdf->Cell(25,7,'Mgf Date(s)',1,0);
								$pdf->Cell(30,7,'Quantity',1,0);
								$pdf->Cell(30,7,'Unit Value',1,0);
								$pdf->Cell(0,7,'Total Value',1,1);$pdf->SetFont('','',9);
							$prod_rec = DB::table('tra_permits_products as t1')
																		->leftJoin('tra_product_information as t2', 't1.product_id', 't2.id')
																		->leftJoin('par_dosage_forms as t3', 't1.dosage_form_id', 't3.id')
																		->leftJoin('par_packaging_units as t4', 't1.packaging_unit_id', 't4.id')
																		->leftJoin('par_common_names as t5', 't1.common_name_id', 't5.id')
																		->leftJoin('par_si_units as t6', 't1.unitpack_unit_id', 't6.id')
																		->leftJoin('par_currencies as t7', 't1.currency_id', 't7.id')
																		->leftJoin('tra_manufacturers_information as t8', 't1.manufacturer_id', 't8.id')
																		->leftJoin('par_countries as t9', 't1.country_oforigin_id', 't9.id')
																		->select('t1.*','t7.name as currency_name','t8.name as manufacturer_name',  't4.name as packaging_unit','t1.product_strength','t5.name as generic_name','t1.permitcommon_name', 't2.brand_name','t9.name as country_name', 't3.name as dosage_form', 't6.name as si_unit', 't1.unitpack_size', 't1.product_strength')
																		->where(array('application_code'=>$record->application_code))
																		->get();
											$prod_counter = $prod_rec->count();		
								$currency_name = '';											
								$total_amount = 0;											
								if($prod_counter >0){
											$i=1;
									foreach($prod_rec as $rec){
										if(validateIsNumeric($rec->product_id)){
												
												$permit_brandname = $rec->brand_name.' '.$rec->generic_name .' '.$rec->product_strength.'. Manufacturer: '.$rec->manufacturer_name.' Country: '.$rec->country_name;
										}
										else{	
												$permit_brandname = $rec->permitbrand_name.' '.$rec->permitcommon_name .' '.$rec->product_strength.'. Manufacturer: '.$rec->manufacturer_name.' Country: '.$rec->country_name;

										}		
										$amount = $rec->unit_price*$rec->quantity;										
										$packaging_data = $rec->unitpack_size.' '.$rec->si_unit;
										$product_batch_no = $rec->product_batch_no;
										$manufacturing_dates = 'Mgf Date: '.formatDateRpt($rec->product_manufacturing_date).' Exp. Date'.formatDateRpt($rec->product_expiry_date);
											
											$rowcount = max(PDF::getNumLines($permit_brandname, 45),PDF::getNumLines($packaging_data, 25),PDF::getNumLines($packaging_data, 25),PDF::getNumLines($packaging_data, 25));
											
											$pdf->MultiCell(10,5*$rowcount,$i,1,'',0,0);
											$pdf->MultiCell(45,5*$rowcount,$permit_brandname,1,'',0,0);
											$pdf->MultiCell(30,5*$rowcount,$rec->unitpack_size.' '.$rec->si_unit,1,'',0,0);
											
											//$pdf->MultiCell(25,5*$rowcount,$product_batch_no,1,'',0,0);
											//$pdf->MultiCell(25,5*$rowcount,$manufacturing_dates,1,'',0,0);
											$pdf->MultiCell(30,5*$rowcount,$rec->quantity,1,'',0,0);
											$pdf->MultiCell(30,5*$rowcount,($rec->unit_price).' ',1,'',0,0);
											$pdf->MultiCell(0,5*$rowcount,formatMoney($amount).' '.$rec->currency_name,1,'R',0,1);	
													$i++;
											$currency_name = $rec->currency_name;
											$total_amount = $total_amount+$amount;
									} 
									$pdf->Cell(140,7,'Total Value:',1,0, 'R');
										$pdf->Cell(0,7,formatMoney($total_amount).' '.$currency_name,1,1, 'R');
								}   $pdf->SetFont('','',10);
								$pdf->ln();
								
								$pdf->Cell(0,5,'Name of the Supplier: '.strtoupper($record->suppler_name),0,1);
									 
									 $pdf->Cell(0,5,'Address: '.$record->postal_address,0,1);
									 $pdf->Cell(0,5,'Physical Location: '.strtoupper($record->suppler_address),0,1);
									 $pdf->Cell(0,5,'Country: '.strtoupper($record->supplier_country),0,1);
								$pdf->ln();
								
								$pdf->WriteHTML("This certificate gives the right to the above importer to confirm an order/purchase order of the products specified in Proforma Invoice number <b>".$record->proforma_invoice_no."</b>  and to apply for an import license.", true, 0, true, true,'J');
								
								$pdf->Cell(45,8,'This Certficate is valid up to: ',0,0);
								$pdf->SetFont('','B',10);
								$pdf->Cell(0,8,formatDateRpt($record->permit_expiry_date),0,0);
								$pdf->SetFont('','',10);
								
								$permit_signitory = '';
								$title= 'ACTING';
								$title= '';
								$approved_by = '';
												
								$this->getCertificateSignatoryDetail($record,$pdf);
								if($permit_watermark != ''){
									
									$this->printWaterMark($pdf,$permit_watermark);
								}
									$pdf->Output($permit_title.'.pdf');

						}
					
										
					
		}catch (\Exception $exception) {
				//DB::rollBack();
				$res = array(
					'success' => false,
					'message' => $exception->getMessage()
				);
			} catch (\Throwable $throwable) {
				//DB::rollBack();
				$res = array(
					'success' => false,
					'message' => $throwable->getMessage()
				);
			}
			print_r($res);
			exit();
			//
        return response()->json($res);
		
		
		
		
	}public function printImportExportLetterofRejection($application_code,$record,$permit_watermark){
		
		try{
			
				
					
		}catch (\Exception $exception) {
				//DB::rollBack();
				$res = array(
					'success' => false,
					'message' => $exception->getMessage()
				);
			} catch (\Throwable $throwable) {
				//DB::rollBack();
				$res = array(
					'success' => false,
					'message' => $throwable->getMessage()
				);
			}
			
			
        return response()->json($res);
		
		
	}
	function printRequestForPremisesCAPAResponses($req){
		
		 try {
			
				$application_code = $req->application_code;
				$module_id = $req->module_id;
				$query_id = $req->query_id;
				
					$module_data = getTableData('modules', ['id'=>$module_id]);
					
					$requestadditionalinfo_timespan =getTableData('par_requestadditionalinfo_timespan', ['module_id'=>$module_id]);
					if(!isset($requestadditionalinfo_timespan->time_span)){
						$time_span =23;
					}else{
						
						$time_span =$requestadditionalinfo_timespan->time_span ;
						
					}
							if(!isset($module_data->table_name)){
								return "Module details not found";
							}
					
					$app_data = DB::table('tra_premises_applications as t1')
								->join('tra_premises as t2', 't1.premise_id', 't2.id')
								->leftJoin('par_countries as t3', 't2.country_id', 't3.id')
								->leftJoin('par_regions as t4', 't2.region_id', 't4.id')
								->leftJoin('par_regions as t5', 't2.district_id', 't5.id')
								->leftJoin('tra_premiseinspection_applications as t6', 't1.application_code', 't6.application_code')
								->where('t1.application_code', $application_code)
								->select('t1.premise_id','t2.name as premises_name', 't2.*' ,'t1.reference_no', 't1.tracking_no', 't2.*', 't3.name as country_name', 't4.name as region_name', 't5.name as district_name','t6.actual_start_date' ,'t6.actual_end_date')
								->first();
					if(!$app_data){
						return "Application details not found";
					}

					$org_info = getOrganisationInfo();
					$pdf = new PdfLettersProvider();
					$pdf->setMargins(14,25,14,true);
					$pdf->AddPage();$pdf->setCellHeightRatio(1.5); 
						$template_url = base_path('/');
						$actual_start_date = formatDateRpt($app_data->actual_start_date);
						$actual_end_date = formatDateRpt($app_data->actual_end_date);
						$inspection_date =$actual_start_date.'-'.$actual_end_date;
					if($actual_start_date == $actual_end_date){
						$inspection_date =$actual_start_date; 
						
					}
					 $pdf->Cell(0,3,'',0,1);
					
						$pdf->Cell(0,3,'',0,1);
				
					$pdf->Cell(0,5,'',0,1);
					$pdf->SetFont('times','B',12);
					
					
					$pdf->SetFont('times','B',10);

					$pdf->SetFont('times','',10);
					$application_no = '';
	
					if($app_data->reference_no != ''){

						$application_no .= 	' '.$app_data->reference_no;
					}
						
					$data = '{"tracking_no":'.$app_data->tracking_no.',"module_id":'.$module_id.',"application_code":'.$application_code.'}';

					$styleQR = array('border' => false, 'padding' => 0, 'fgcolor' => array(0, 0, 0), 'bgcolor' => false);
					
					$pdf->SetFont('times','',12);
					//Letter heading 
					$pdf->ln();$pdf->SetFont('times','B',11);
				
					$pdf->Cell(0,8,'Mr/Mrs. '.$app_data->managing_director.',',0,1);
					$pdf->Cell(0,8,$app_data->premises_name.',',0,1);
					$pdf->Cell(0,8,'Tel: '.$app_data->telephone.',',0,1);
					$pdf->Cell(0,8,'Email: '.$app_data->email.',',0,1);
					
					$pdf->Cell(0,8,$app_data->district_name.', '.$app_data->region_name,0,1);
					$pdf->SetFont('times','B',11);$pdf->ln();
					$pdf->WriteHTML('Re: 	Feedback for Premises Application with Reference:'.$application_no); 
					$pdf->SetFont('times','',11);
						$pdf->ln();
					$template = "Reference is made to the Law No 003/2018 of 09/02/2018 establishing Rwanda Food and Drugs Authority and determining its mission, organization and functioning:";

					$pdf->WriteHTML($template);
					$pdf->SetFont('times','',11);
					
					$template = "Reference is equally made to the premise licensing inspection conducted at your processing facility on:".$inspection_date;

					$pdf->WriteHTML($template);
					
					$template = "In line with above references, the inspection findings revealed that there are still the non-compliances and corrective actions recommended to comply with the requirements of Rwanda FDA for premise licensing, including:";

					$pdf->WriteHTML($template);
					
					$pdf->Cell(0,5,'',0,1);
					$request_data = DB::table('tra_inspectioncapa_deficiencies as t1')
									->join('tra_appinspectioncapa_reftracker as t2', 't1.inspection_capa_id', 't2.id')
									->leftJoin('par_deficiencies_categories as t3', 't1.deficiencies_category_id', 't3.id')
									->select('t1.deficiencies')
									->where('t2.id', $query_id)
									->get();

					$pdf->SetFont('times','',11);

					$counter = 1;
					$is_live_signature=0;
					$sign_data='';
					$query_date = Carbon::now();
					
					
						$pdf->SetFont('times','I',11);
					foreach ($request_data as $data){
						$pdf->SetTextColor(0,0,0);
							//$query_data = $data->checklist_item.': '.$data->query;
							$query_data = $data->deficiencies;
							$pdf->Cell(12,5,$counter.'. ',0,0);

							// $pdf->WriteHTML($query_data, true, false, true, true);
							if($query_data != ''){
								$pdf->WriteHTML($query_data); 
								$pdf->ln();
							}
							

						$counter++;
					}//setPageMark

					$pdf->cell(10,3,'',0,1);
					$template = "You are advised to inform Rwanda FDA when the aforementioned recommendations have been implemented, for re-inspection of your premise.";
					$pdf->WriteHTML($template); 
					$pdf->ln();
					$template = $app_data->premises_name." is not allowed to manufacture or put the products on the market without Rwanda FDA authorization.  ";
					$pdf->WriteHTML($template); 
					$dt =strtotime($query_date); //gets dates instance
					$year = date("Y", $dt);
					$month = date("F", $dt);
					$day = date("d", $dt);

						$pdf->Cell(0, 0,'Dated this '.$day.' day of '.$month.', '.$year, 0, 1, '', 0, '', 3);
					$pdf->cell(0,8,'',0,1);
						
					
							$pdf->Cell(0, 0, 'Sincerely,',0,1,'');
							$pdf->Cell(0, 0, 'By Authority Delegation,',0,1,'');
							
							$pdf->Output('CAPA feedBack Letter('.$application_no.').pdf',"I");
			} catch (\Exception $exception) {
            $res = sys_error_handler($exception->getMessage(), 2, debug_backtrace(DEBUG_BACKTRACE_IGNORE_ARGS, 1),explode('\\', __CLASS__), \Auth::user()->id);
        } catch (\Throwable $throwable) {
            $res = sys_error_handler($throwable->getMessage(), 2, debug_backtrace(DEBUG_BACKTRACE_IGNORE_ARGS, 1),explode('\\', __CLASS__), \Auth::user()->id);
        }
		print_r($res);
exit();
        return response()->json($res);
			
	}
	
	
	
	function printREinspectionueryLetter($req){
		
		 try {
			
				$application_code = $req->application_code;
				$module_id = $req->module_id;
				$query_id = $req->query_id;
				
					$module_data = getTableData('modules', ['id'=>$module_id]);
					
					$requestadditionalinfo_timespan =getTableData('par_requestadditionalinfo_timespan', ['module_id'=>$module_id]);
					if(!isset($requestadditionalinfo_timespan->time_span)){
						$time_span =23;
					}else{
						
						$time_span =$requestadditionalinfo_timespan->time_span ;
						
					}
							if(!isset($module_data->table_name)){
								return "Module details not found";
							}
					
					$app_data = DB::table('tra_premises_applications as t1')
								->join('tra_premises as t2', 't1.premise_id', 't2.id')
								->leftJoin('par_countries as t3', 't2.country_id', 't3.id')
								->leftJoin('par_regions as t4', 't2.region_id', 't4.id')
								->leftJoin('par_regions as t5', 't2.district_id', 't5.id')
								->leftJoin('tra_premiseinspection_applications as t6', 't1.application_code', 't6.application_code')
								->where('t1.application_code', $application_code)
								->select('t1.premise_id','t2.name as premises_name', 't2.*' ,'t1.reference_no', 't1.tracking_no', 't2.*', 't3.name as country_name', 't4.name as region_name', 't5.name as district_name','t6.actual_start_date' ,'t6.actual_end_date')
								->first();
					if(!$app_data){
						return "Application details not found";
					}

					$org_info = getOrganisationInfo();
					$pdf = new PdfLettersProvider();
					$pdf->setMargins(14,25,14,true);
					$pdf->AddPage();$pdf->setCellHeightRatio(1.5); 
						$template_url = base_path('/');
						$actual_start_date = formatDateRpt($app_data->actual_start_date);
						$actual_end_date = formatDateRpt($app_data->actual_end_date);
						$inspection_date =$actual_start_date.'-'.$actual_end_date;
					if($actual_start_date == $actual_end_date){
						$inspection_date =$actual_start_date; 
						
					}
					 $pdf->Cell(0,3,'',0,1);
					
						$pdf->Cell(0,3,'',0,1);
				
					$pdf->Cell(0,5,'',0,1);
					$pdf->SetFont('times','B',12);
					
					
					$pdf->SetFont('times','B',10);

					$pdf->SetFont('times','',10);
					$application_no = '';
	
					if($app_data->reference_no != ''){

						$application_no .= 	' '.$app_data->reference_no;
					}
						
					$data = '{"tracking_no":'.$app_data->tracking_no.',"module_id":'.$module_id.',"application_code":'.$application_code.'}';

					$styleQR = array('border' => false, 'padding' => 0, 'fgcolor' => array(0, 0, 0), 'bgcolor' => false);
					
					$pdf->SetFont('times','',12);
					//Letter heading 
					$pdf->ln();$pdf->SetFont('times','B',11);
				
					$pdf->Cell(0,8,'Mr/Mrs. '.$app_data->managing_director.',',0,1);
					$pdf->Cell(0,8,$app_data->premises_name.',',0,1);
					$pdf->Cell(0,8,'Tel: '.$app_data->telephone.',',0,1);
					$pdf->Cell(0,8,'Email: '.$app_data->email.',',0,1);
					
					$pdf->Cell(0,8,$app_data->district_name.', '.$app_data->region_name,0,1);
					$pdf->SetFont('times','B',11);$pdf->ln();
					$pdf->WriteHTML('Re: 	Feedback for Premises Application with Reference:'.$application_no); 
					$pdf->SetFont('times','',11);
						$pdf->ln();
					$template = "Reference is made to the Law No 003/2018 of 09/02/2018 establishing Rwanda Food and Drugs Authority and determining its mission, organization and functioning:";

					$pdf->WriteHTML($template);
					$pdf->SetFont('times','',11);
					
					$template = "Reference is equally made to the premise licensing inspection conducted at your processing facility on:".$inspection_date;

					$pdf->WriteHTML($template);
					
					$template = "In line with above references, the inspection findings revealed that there are still the non-compliances and corrective actions recommended to comply with the requirements of Rwanda FDA for premise licensing, including:";

					$pdf->WriteHTML($template);
					
					$pdf->Cell(0,5,'',0,1);
					$request_data = DB::table('reinspectiontitems_queries as t1')
									->join('tra_appreinspectionrequest_reftracker as t2', 't1.query_id', 't2.id')
									->leftJoin('par_deficiencies_categories as t3', 't1.deficiencies_category_id', 't3.id')
									->select('t1.query')
									->where('t2.id', $query_id)
									->get();

					$pdf->SetFont('times','',11);

					$counter = 1;
					$is_live_signature=0;
					$sign_data='';
					$query_date = Carbon::now();
					
					
						$pdf->SetFont('times','I',11);
					foreach ($request_data as $data){
						$pdf->SetTextColor(0,0,0);
							//$query_data = $data->checklist_item.': '.$data->query;
							$query_data = $data->query;
							$pdf->Cell(12,5,$counter.'. ',0,0);

							// $pdf->WriteHTML($query_data, true, false, true, true);
							if($query_data != ''){
								$pdf->WriteHTML($query_data); 
								$pdf->ln();
							}
							

						$counter++;
					}//setPageMark

					$pdf->cell(10,3,'',0,1);
					$template = "You are advised to inform Rwanda FDA when the aforementioned recommendations have been implemented, for re-inspection of your premise.";
					$pdf->WriteHTML($template); 
					$pdf->ln();
					$template = $app_data->premises_name." is not allowed to manufacture or put the products on the market without Rwanda FDA authorization.  ";
					$pdf->WriteHTML($template); 
					$dt =strtotime($query_date); //gets dates instance
					$year = date("Y", $dt);
					$month = date("F", $dt);
					$day = date("d", $dt);

						$pdf->Cell(0, 0,'Dated this '.$day.' day of '.$month.', '.$year, 0, 1, '', 0, '', 3);
					$pdf->cell(0,8,'',0,1);
						
							$pdf->Cell(0, 0, 'Sincerely,',0,1,'');
							$pdf->Cell(0, 0, 'By Authority Delegation,',0,1,'');
							
							$pdf->Output('RE-Inspection feedBack Letter('.$application_no.').pdf',"I");
			} catch (\Exception $exception) {
            $res = sys_error_handler($exception->getMessage(), 2, debug_backtrace(DEBUG_BACKTRACE_IGNORE_ARGS, 1),explode('\\', __CLASS__), \Auth::user()->id);
        } catch (\Throwable $throwable) {
            $res = sys_error_handler($throwable->getMessage(), 2, debug_backtrace(DEBUG_BACKTRACE_IGNORE_ARGS, 1),explode('\\', __CLASS__), \Auth::user()->id);
        }
		print_r($res);
exit();
        return response()->json($res);
			
	}
	function generateRequestForAdditionalInformation($req){
		
		$application_code = $req->application_code;
		$module_id = $req->module_id;
		$query_id = $req->query_id;
		if(!validateIsNumeric($module_id)){
			$app_data = DB::table('tra_submissions')
            ->select('module_id')
			->where(array('application_code'=>$application_code))
            ->first();
			if($app_data){
						$module_id = $app_data->module_id;
					}
			}
			
			
			
			$module_data = getTableData('modules', ['id'=>$module_id]);
			
			$requestadditionalinfo_timespan =getTableData('par_requestadditionalinfo_timespan', ['module_id'=>$module_id]);
			if(!isset($requestadditionalinfo_timespan->time_span)){
				$time_span =23;
			}else{
				
				$time_span =$requestadditionalinfo_timespan->time_span ;
				
			}
					if(!isset($module_data->table_name)){
						return "Module details not found";
					}
			 $invoice_details = getInvoiceDetails($module_id, '',$application_code);
			 $app_description= '';
			if(isset($invoice_details)){
				$app_description = $invoice_details['module_desc'];
			}
			$app_data = DB::table($module_data->table_name.' as t1')
						->join('wb_trader_account as t2', 't1.applicant_id', 't2.id')
						->leftJoin('par_countries as t3', 't2.country_id', 't3.id')
						->leftJoin('par_regions as t4', 't2.region_id', 't4.id')
						->where('application_code', $application_code)
						->select('t1.applicant_id','t1.reference_no', 't1.tracking_no', 't2.*', 't3.name as country_name', 't4.name as region_name')
						->first();
			if(!$app_data){
				return "Application details not found";
			}

			$org_info = getOrganisationInfo();
			$pdf = new mPDF( [
					'mode' => 'utf-8',
					'format' => 'A4',
					'margin_header' => '3',
					'margin_top' => '20',
					'margin_bottom' => '20',
					'margin_footer' => '2',
					'tempDir'=> '/opt/lampp/htdocs/mis/backend/public/resources'
				]); 
			// $pdf = new PdfLettersProvider();
			$pdf->setMargins(5,25,5,true);
			$pdf->AddPage();
				$template_url = base_path('/');
				$pdf->setSourceFile($template_url."resources/templates/certificate_template.pdf");
				// import page 1
				$tplId = $pdf->importPage(1);	
				$pdf->useTemplate($tplId,0,0);
				$logo = getcwd() . '/resources/images/zamra-logo.png';
				$pdf->Image($logo,90,15,34,30);
				//$pdf->setPageMark();

			// $pdf->SetFont('times','B',9);
			// $pdf->Cell(0,1,'',0,1);

			$pdf->Cell(0,4,'',0,1,'R');
			// $pdf->Cell(0,4,'',0,1,'R');
			$pdf->SetFont('times','B',12);
			// $pdf->Cell(0,15,'',0,1);
			$pdf->Cell(0,4,$org_info->org_name,0,1,'C');
			$pdf->Cell(0,4,'The Medicines and Allied Substances Act, 2013',0,1,'C');

			$pdf->SetFont('times','B',12);
			$pdf->Cell(0,4,'(Act No. 3 of 2013)',0,1,'C');
			//$pdf->Cell(0,30,'',0,1);


			 $pdf->Cell(0,3,'',0,1);
				$startY = $pdf->y;
			$startX = $pdf->x;
			$pdf->SetLineWidth(0.3);
			$pdf->Line(0+55,$startY,160,$startY);
				$pdf->Cell(0,3,'',0,1);
			if($module_id == 4){
					$regulation_title = "The Medicines and Allied Substances (Importation and Exportaion) Regulations, 2017";
					$pdf->Cell(0,4,$regulation_title,0,1,'C');

			}
			else if($module_id == 2){
				//get the premises types 
				$record = DB::table('tra_premises_applications as t1')
								->join('tra_premises as t2', 't1.premise_id', 't2.id')
								->leftJoin('par_premises_types	 as t7', 't2.premise_type_id', 't7.id')
								->select('t7.act_name as premises_type')
								->where('application_code',$application_code)
								->first();
					if($record){
						$premise_type = $record->premises_type;
						
					$regulation_title = $premise_type;
					}else{
						
					$regulation_title = "The Medicines and Allied Substances (Certificate of Registration) Regulations, 2017";
					}
					$pdf->Cell(0,4,$regulation_title,0,1,'C');

			}
			else{
				$regulation_title = "The Medicines and Allied Substances";
				$pdf->Cell(0,4,$regulation_title,0,1,'C');
				$regulation_title = "(Marketing Authorisation of Medicines) Regulations, 2019";
				
				$pdf->Cell(0,4,$regulation_title,0,1,'C');
			}
			

			$pdf->Cell(0,5,'',0,1);
			$pdf->SetFont('times','B',12);
			
			$pdf->WriteHTML('REQUEST FOR ADDITIONAL INFORMATION FOR '.strtoupper($app_description)); 
			$pdf->SetFont('times','B',10);

			$pdf->SetFont('times','',10);
			$application_no = '';

			if($app_data->tracking_no != ''){
				
				$application_no = 	$app_data->tracking_no;
				
			}
			if($app_data->reference_no != ''){

				$application_no .= 	' '.$app_data->reference_no;
			}
			$pdf->Cell(0,10,'Application Reference:'.$application_no,0,1, 'R');
				// $pdf->MultiCell(0,10,'Application Reference:<u>'.$app_data->tracking_no.'</u>',0,'R',0,1,'','',true,0,true);
			$data = '{"tracking_no":'.$app_data->tracking_no.',"module_id":'.$module_id.',"application_code":'.$application_code.'}';

			$styleQR = array('border' => false, 'padding' => 0, 'fgcolor' => array(0, 0, 0), 'bgcolor' => false);
			// QRCODE,H : QR-CODE Best error correction
			// $pdf->write2DBarcode($data, 'QRCODE,H', 178, 28, 16, 16);

			// $barcode = "<barcode code='".$data."' type='CODE11' height='0.66' text='1' />";
			//$pdf->writeBarcode('111111111',0, 178, 28);
			$pdf->SetFont('times','',12);
			//Letter heading 
			$pdf->Cell(0,8,'To:',0,1);
			$pdf->Cell(0,8,$app_data->name.',',0,1);
			if($app_data->physical_address != ''){
					$pdf->Cell(0,8,$app_data->physical_address.',',0,1);

				}		
				if(($app_data->physical_address !=  $app_data->postal_address)){
					
						$pdf->Cell(0,8,$app_data->postal_address.',',0,1);
				}
			//$pdf->Cell(0,8,$app_data->physical_address.',',0,1);
			//$pdf->Cell(0,8,$app_data->postal_address.',',0,1);
			$pdf->Cell(0,8,$app_data->region_name." ".$app_data->country_name,0,1);

			$pdf->SetFont('times','',11);
			//$pdf->ln();

			//add query header tag
			$template = "You are requested to furnish, the following information or documents in request of your application for ".$module_data->name." within ".$time_span." days of this request.";

			$pdf->WriteHTML($template);
			$pdf->SetFont('times','B',12);
			//add query items
			//loop through requests
			//$pdf->ln();

			$pdf->Cell(0,5,'',0,1);
			$request_data = DB::table('checklistitems_queries as t1')
							->join('tra_application_query_reftracker as t2', 't1.query_id', 't2.id')
							->leftJoin('par_checklist_items as t3', 't1.checklist_item_id', 't3.id')
							->select('t1.query', 't1.comment', 't2.queried_on', 't2.is_live_signature','t3.name as checklist_item', 't2.sign_file')
							->where('t2.id', $query_id)
							->get();

			$pdf->SetFont('times','',11);

			$counter = 1;
			$is_live_signature=0;
			$sign_data='';
			$query_date = Carbon::now();
			
			
				
			foreach ($request_data as $data){
				$pdf->SetTextColor(0,0,0);
					//$query_data = $data->checklist_item.': '.$data->query;
					$query_data = $data->query;
					$pdf->Cell(12,5,$counter.'. ',0,0);

					// $pdf->WriteHTML($query_data, true, false, true, true);
					if($query_data != ''){
						$pdf->WriteHTML($query_data); 
						$pdf->ln();
					}
					

				$counter++;
			}//setPageMark

			$pdf->cell(10,3,'',0,1);
			$template = "<p  align='justify'>If you fail to furnish the requested information within the stipulated period, your application will be treated as invalid and be rejected</b></p>";
			$pdf->WriteHTML($template); 
			$pdf->ln();

			$dt =strtotime($query_date); //gets dates instance
			$year = date("Y", $dt);
			$month = date("F", $dt);
			$day = date("d", $dt);

				$pdf->Cell(0, 0,'Dated this '.$day.' day of '.$month.', '.$year, 0, 1, '', 0, '', 3);
			$pdf->cell(0,8,'',0,1);
					$startY = $pdf->y;
			$startX =$pdf->x;
			$signiture = getcwd() . '/backend/resources/templates/signatures_uploads/dg_sinatory.png';
			//$pdf->Image($signiture,$startX+75,$startY-7,30,12);
					//$pdf->Cell(0, 0, '___________________________',0,1,'C');
					$pdf->Cell(0, 0, 'On behalf of ZAMRA',0,1,'');
			return response($pdf->Output('Request for Additional Information('.$application_no.').pdf',"I"),200)->header('Content-Type','application/pdf');
																			
						
		
		
	}
	function printPromotionalRegCertificate($req){
			try{
							$application_code = $req->application_code;
								$logo=getcwd().'/assets/images/logo.jpg';
								
								
								$org_info = getOrganisationInfo();
								$pdf = new PdfProvider();
								$this->getCertificateHeader($pdf, '');
												
								$records = DB::table('tra_promotion_adverts_applications as t1')
														->leftJoin('par_system_statuses as q', 't1.application_status_id', '=', 'q.id')
														->leftJoin('tra_approval_recommendations as t2','t1.application_code', 't2.application_code')
														->join('wb_trader_account as t3', 't1.applicant_id', 't3.id')
														->leftJoin('par_countries as t4', 't3.country_id', 't4.id')
														->leftJoin('par_regions as t5', 't3.region_id', 't5.id')
														->leftJoin('par_sections as t6', 't1.section_id', 't6.id')
														->leftJoin('users as t17', 't2.permit_signatory', '=', 't17.id')
														->select(DB::raw("t2.decision_id as recommendation_id, t1.*, t3.name as applicant_name, t3.physical_address, t3.postal_address,t3.email, t4.name as country_name,t2.permit_signatory,concat(decrypt(t17.first_name),' ',decrypt(t17.last_name)) as permit_signatoryname,t3.telephone_no, t5.name as region_name,t6.name as section_name, t1.id as application_id, t2.expiry_date , t2.approval_date"))
														->where('t1.application_code',$application_code)
														->first();
								if($records){
									$row = $records;
									$recommendation_id = $row->recommendation_id;
									$ref = $row->reference_no;
									$applicant_name = $row->applicant_name;
									$physical_address = $row->physical_address;
									$postal_address = $row->postal_address;
									$region_name = $row->region_name;
									$country_name = $row->country_name;
									$email_address  = $row->email;
									$telephone = $row->telephone_no;
									
									$section_id = $row->section_id;
									$section_name = $row->section_name;
									$expiry_date = $row->expiry_date;
									$approval_date = $row->approval_date;
									$date_received = $row->date_received;
									$application_id = $row->application_id;
									$this->funcGenerateQrCode($row,$pdf);
									
									$pdf->SetFont('times','',11);
										$pdf->Cell(0,26,'',0,1);$pdf->SetFont('times','B',9);
										$pdf->Cell(60,5,'Ref.:'.$ref,0,0);
										$pdf->Cell(0,5,'Date.:'.formatDateRpt($approval_date),0,1,'R');
										$logo = getcwd() . '/resources/images/org-logo.jpg';
											
											$pdf->Cell(0,5,$applicant_name,0,1);
											$pdf->Cell(0,5,$physical_address,0,1);
											
											$pdf->Cell(0,5,'P.O. Box '.$postal_address.' '.$region_name.','.$country_name,0,1);
											$pdf->Cell(0,5,'E-mail: '.$email_address,0,1);
											$pdf->Cell(0,5,'Tel: '.$telephone,0,1);
											$pdf->ln();
											
										if($section_id == 2){
											$section_name = 'medicines';
										}
										$pdf->SetLineWidth(3);
											$pdf->SetFont('','B',11);
											if($recommendation_id == 1){
												
												$statement= 'RE: APPLICATION FOR APPROVAL OF PROMOTIONAL MATERIAL FOR '.strtoupper($section_name);
											}
											else{
												$statement= 'RE: REFUSAL OF APPLICATION FOR PROMOTIONAL MATERIAL FOR '.strtoupper($section_name);
											
											}
											$pdf->MultiCell(0,5,$statement.".\n" ,0, 'J', 0, 1, '', '', true);
											$pdf->SetFont('','',11);
											$pdf->ln();
											$pdf->MultiCell(0,4,'Reference is made to the law No. 003/2018 of 09/02/2018 establishing Rwanda FDA, especially in its article 8, paragraph 11, where the Authority is mandated to regulate and analyse information used in the promotion, advertising and marketing of regulated products;'.".\n" ,0, 'J', 0, 1, '', '', true);
											$pdf->Cell(0,1,'',0,1);
											
											$pdf->MultiCell(0,4,'Further reference is made to the regulations No. CBD/TRG/017 Rev_1 governing promotion, advertisement and marketing of regulated products;'.".\n" ,0, 'J', 0, 1, '', '', true);
											$pdf->Cell(0,1,'',0,1);
											
											$pdf->MultiCell(0,4,'Considering the guidelines No. DIS/GDL/050 for control of promotion, advertisement and marketing of medicines, medical devices and cosmetics in Rwanda;'.".\n" ,0, 'J', 0, 1, '', '', true);
									$pdf->Cell(0,1,'',0,1);
											
											$pdf->MultiCell(0,4,'Cognizant of your application letter dated '.formatDateRpt($date_received).', submitted along with other supporting documents;'.".\n" ,0, 'J', 0, 1, '', '', true);
											
										$material_rec =	DB::table('tra_promotion_materials_details as t1')
			 
												->join('par_promotion_material_items  as t2','t1.material_id','=','t2.id')
												->select(DB::raw("group_concat(concat(t2.name) separator ' / ') as promotion_material")) 
												->where('t1.application_id',$application_id)
												->first();
										
											$promotion_material = '';
											if($material_rec){
												$promotion_material = $material_rec->promotion_material;
												
											}
											$pdf->ln();
											$pdf->MultiCell(0,5,'Rwanda FDA approves the submitted branding material '.$promotion_material.' for Pharmacies and recommends its use as per mentioned in your application. Additionally, compliance with product registration requirements is mandatory for future applications.'.".\n" ,0, 'J', 0, 1, '', '', true);
											$pdf->Cell(7,5,'',0,1);
											
											$adverttype_rec =DB::table('tra_promotion_prod_particulars as t1')
													->leftJoin('par_common_names as t2','t1.common_name','=','t2.id')
													->leftJoin('par_product_categories as t3','t1.product_category_id','=','t3.id')
													->leftJoin('par_subproduct_categories as t4','t1.product_subcategory_id','=','t4.id')
													->select(DB::raw('t1.*,t3.name as product_category_name,t4.name as product_subcategory_name, t2.name as common_name'))
													->where('t1.application_id',$application_id)
													->get();
												$tbl = '
												<table width="100%" cellspacing="0" cellpadding="1" border = "0.4" >
													<tr style="font-weight:bold;" >
														<td width="5%">S/n</td>
														<td width="49%">Brand Name</td>
														<td width="31%">Generic Name</td>
														<td width="14%">Registration Number</td>
													</tr>';
													$i= 1;
											if($adverttype_rec){
												foreach($adverttype_rec as $rows1){
													$tbl .= '<tr style="font-weight:normal;" >
															<td width="5%">'.$i.'</td>
															<td width="49%" stype="">'.$rows1->brand_name.'</td>
															<td width="31%">'.$rows1->common_name.'</td>
															<td width="14%">'.$rows1->registration_no.'</td>
														</tr>';
													$i++;
												}
												
											}
											$tbl .= "</table>
											";
											$pdf->writeHTML($tbl, true, false, false, false, '');
											
									if($recommendation_id == 1){
										//the data 
											
											$pdf->MultiCell(0,5,'3. Approval is hereby granted for use of promotion of your product(s), as long as the product(s) continue to comply with registration requirements as prescribed in the regulations No. CBD/TRG/017. Validity of this permit expires on '.date('d-m-Y', strtotime($expiry_date)).".\n" ,0, 'J', 0, 1, '', '', true);
											$pdf->Cell(7,5,'',0,1);
											
									}
									else{
											$pdf->MultiCell(0,5,"3.	The advert has not been approved due to the following reason(s):-.\n" ,0, 'J', 0, 1, '', '', true);
											$pdf->Cell(7,5,'',0,1);
											$pdf->MultiCell(0,5,"4.	Note that the material should neither be imported nor used in the country for promotional purposes.\n" ,0, 'J', 0, 1, '', '', true);
											
									}
									$pdf->Cell(0,5,'We thank you for your cooperation',0,1);
									$pdf->ln();
									$permit_signitory = '';
														$title= '';	$pdf->ln();
														$approved_by= '';
														$permit_signitory = '';
												$title= 'ACTING';
												$title= '';
												$approved_by = '';
												
												$this->getCertificateSignatoryDetail($row,$pdf);
												
												
								}
									$pdf->Output("Promotional Advertisement.pdf");
	
						return;
						} catch (\Exception $exception) {
								//$pdf->rollBack();
								$res = array(
									'success' => false,
									'message' => $exception->getMessage()
								);
						} catch (\Throwable $throwable) {
								//$pdf->rollBack();
								$res = array(
									'success' => false,
									'message' => $throwable->getMessage()
								);
						}
						//

		
		return $res;
		
	}
	public function funcGenerateApplicationInvoice($invoice_id,$application_id,$application_code,$module_id,$sub_module_id){
		if(!validateIsNumeric($module_id)){
			 $module_details = getTableData('sub_modules', array('id' => $sub_module_id));
			 if($module_details){
				  $module_id = $module_details->module_id;
		
			 }
       	 
		 }
		if(!validateIsNumeric($invoice_id)){
			$invoice_record = DB::table('tra_application_invoices')->where('application_code',$application_code)->first();
			if($invoice_record){
					$invoice_id = $invoice_record->id;
			}
		 }
		
		  $invoice_details = getInvoiceDetails($module_id, $application_id,$application_code);
		 $app_description= '';
		if(isset($invoice_details)){
            $app_description = $invoice_details['module_desc'];
        }
		//check the paymetn Control Number 
		$rec = DB::table('tra_application_invoices as t1')
					->leftJoin('wb_trader_account as t2','t1.applicant_id', 't2.id')
					->leftJoin('par_countries as t3', 't2.country_id','t3.id')
					->leftJoin('par_regions as t4', 't2.region_id','t4.id')
					->leftJoin('modules as t5', 't1.module_id','t5.id')
					->leftJoin('sub_modules as t6', 't1.sub_module_id','t6.id')
					->leftJoin('tra_iremboinvoices_information as t7', 't1.invoice_no','t7.rfdaInvoiceNo')
					->select('t1.*','t2.name as applicant_name','t7.iremboInvoiceNumber', 't2.postal_address', 't2.email','t2.telephone_no','t3.name as country_name','t4.name as region_name', 't5.name as module_name', 't6.name as sub_module')
					->where(array('t1.id'=>$invoice_id))->first();
		if($rec){
			$PayCntrNum = $rec->PayCntrNum;
			
					$params = array(
						'invoice_id' => $invoice_id,
						'application_code'=>$application_code
					);
					$iremboInvoiceNumber = $rec->iremboInvoiceNumber;

				$org_info = getOrganisationInfo();
				$pdf = new PdfLettersProvider();
				$pdf->AddPage();
				$template_url = base_path('/');
				$pdf->setSourceFile($template_url."resources/templates/certificate_template.pdf");
																		// import page 1
				$tplId = $pdf->importPage(1);	
				$pdf->useTemplate($tplId,0,0);
				$pdf->setPageMark();
							
							
				$pdf->SetFont('times','B',9);
				$pdf->Cell(0,1,'',0,1);
				$pdf->setPrintHeader(false);
				$pdf->setPrintFooter(false);
				
				$org_rec = getSingleRecord('tra_organisation_information', array('id'=>1));
				$logo = getcwd() . '/resources/images/org-logo.jpg';
				$pdf->SetFont('times', 'B', 12);
				$this->returnReportHeader($pdf,$org_rec,$rec, 'PROFORMA INVOICE');
				
			   
				$pdf->Cell(0,7,'Customer Details',0,1);
				$pdf->SetFont('times', '', 11);
				
				$pdf->Cell(0,7,$rec->applicant_name,0,1);
				$pdf->Cell(0,7,$rec->postal_address.', '.$rec->region_name.', '.$rec->country_name,0,1);
				$pdf->Cell(0,7,$rec->telephone_no.' '.$rec->email,0,1);
				$pdf->SetFont('times', 'B', 11);
			   
				$pdf->Cell(0,7,'Invoice Details',0,1);
				$pdf->SetFont('times', '', 11);
			   
				$pdf->Cell(100,7,'Ref No:'. $rec->tracking_no,0,1, '');
				//$pdf->Cell(0,7,'RRA Document Number:'.$rec->DocumentNumber,0,1, 'R'); ///Comersion Invoice Number, FOB Value 
				
				$pdf->Cell(60,7,'Invoice Number: '.$rec->invoice_no,0,0);
				$pdf->Cell(0,7,'Invoice Date:'.$rec->date_of_invoicing.' Due Date: '.formatDate($rec->due_date),0,1, 'R');
				if($iremboInvoiceNumber != ''){
$pdf->SetFont('times', 'B', 15);
			   
							$pdf->Cell(0,7,'iREMBO Pay Invoice No:'.$iremboInvoiceNumber,0,1, 'C');
$pdf->SetFont('times', 'B', 11);
			   
				}
				
				$pdf->ln();
				
				$pdf->MultiCell(0,7,'Invoice Details for '.$rec->module_name.' ('.$rec->sub_module.') '.$app_description,0,'R',0,1);
$pdf->SetFont('times', 'B', 11);
			   
				$pdf->SetLineWidth(0.1);
				//invoice details 
				$pdf->Cell(15,10,'Sn',1,0);
				$pdf->Cell(100,10,'Item Description',1,0,'C');
				$pdf->Cell(40,10,'Price',1,0,'C');
				$pdf->Cell(0,10,'Total',1,1,'C');
				$inv_rec = DB::table('tra_invoice_details as t1')
								->leftJoin('par_currencies as t2','t1.paying_currency_id','t2.id')
								->leftJoin('tra_element_costs as t3','t1.element_costs_id','t3.id')
								->leftJoin('par_cost_elements as t4','t3.element_id','t4.id')
								->leftJoin('par_fee_types as t5','t3.feetype_id','t5.id')
								->leftJoin('par_cost_categories as t6','t3.cost_category_id','t6.id')
								->select(DB::raw(" t4.name AS cost_element, t5.name AS fee_type, t6.name AS cost_category, t1.total_element_amount AS invoice_amount, t1.paying_currency_id,t2.name as currency_name"))
								->where(array('t1.invoice_id'=>$invoice_id))
								->get();
				if($inv_rec){
					
					
					$i = 1;
					$total_amount = 0;
					$currency_name = '';
					$paying_currency_id = '';
					$pdf->SetFont('times', '', 11);
					foreach($inv_rec as $inv){
						$currency_name = $inv->currency_name;
						
						
						
						
						$cost_item = $inv->cost_category." ".$inv->cost_element;
						$paying_currency_id = $inv->paying_currency_id;
							$rowcount = max($pdf->getNumLines($cost_item, 92),$pdf->getNumLines($inv->invoice_amount, 40));
							
						
						$pdf->MultiCell(15,7*$rowcount,$i,1,'',0,0);
						$pdf->MultiCell(100,7*$rowcount,$cost_item,1,'',0,0);
						$pdf->MultiCell(40,7*$rowcount,formatMoney($inv->invoice_amount),1,'R',0,0);
						$pdf->MultiCell(0,7*$rowcount,formatMoney($inv->invoice_amount),1,'R',0,1);
						$total_amount = $total_amount+$inv->invoice_amount;
						
						$i++;
					}
					
					
					$pdf->MultiCell(155,10,'Sub-Total('.$currency_name.')',1,'R',0,0);
					$pdf->MultiCell(0,10,formatMoney($total_amount),1,'R',0,1);
						
					$pdf->MultiCell(155,10,'Total('.$currency_name.')',1,'R',0,0);
					$pdf->MultiCell(0,10,formatMoney($total_amount),1,'R',0,1);
						
				}
				//get the Bank Details based on the paying currency
				
				$bank_rec = DB::table('tra_orgbank_accounts as t1')
								->leftJoin('par_banks as t2', 't1.bank_id', 't2.id')
								->leftJoin('par_bankbranches as t3', 't1.branch_id', 't3.id')
								->leftJoin('par_currencies as t4', 't1.currency_id', 't4.id')
								->select(DB::raw("t4.name as currency_name, t1.account_name, t1.account_no, t1.swft_code, t2.name AS bank_name, t3.name AS branch_name"))
								->where(array('t1.currency_id'=>$paying_currency_id))
								->get();
					if($bank_rec){
						$pdf->MultiCell(0,7,'The amount due must be remitted to the following account:',0,'',0,1);	
						$i = 1;
								foreach($bank_rec as $bank){
									$pdf->MultiCell(100,7,$i.'. '.$bank->account_name.' '.$bank->bank_name." ".$bank->branch_name.' '.$bank->currency_name." Account: ".$bank->account_no. " Swift Code: ".$bank->swft_code,0,'',0,1);	
									
								}
					}						
								
				$pdf->Output('Proforma Invoice.pdf');
				
				
				
		}
		else{
			echo "<h4>Invoice details Not Found</h4>";
		}
		
		
		
	}
	function funcGenerateApplicationReceipt($payment_id,$application_code,$table_name,$application_id,$module_id){
		
		//check the paymetn Control Number 
		$rec = DB::table('tra_payments as t1')
					->join('wb_trader_account as t2','t1.applicant_id', 't2.id')
					->leftJoin('par_countries as t3', 't2.country_id','t3.id')
					->leftJoin('par_regions as t4', 't2.region_id','t4.id')
					->leftJoin('modules as t5', 't1.module_id','t5.id')
					->leftJoin('sub_modules as t6', 't1.sub_module_id','t6.id')
					->leftJoin('par_currencies as t7', 't1.currency_id','t7.id')
					->leftJoin('par_payment_modes as t8', 't1.payment_mode_id','t8.id')
					->leftJoin('users as t9', 't1.usr_id','t9.id')
					->select('t1.*','t2.name as applicant_name','t8.name as payment_mode', 't7.name as currency_name', 't2.postal_address', 't2.email','t3.name as country_name','t4.name as region_name', 't5.name as module_name', 't6.name as sub_module', DB::raw(" CONCAT_WS(' ',decrypt(t9.first_name),decrypt(t9.last_name)) as payment_receivedby"))
					->where(array('t1.id'=>$payment_id))->first();
		if($rec){
			$payment_type_id = $rec->payment_type_id;
			$payment_receivedby = $rec->payment_receivedby;
			if($payment_type_id == 3){
				$this->funcGenerateCreditNote($payment_id);
				
			}
			else{
				$pdf = new PdfLettersProvider();
				$pdf->AddPage('');
				$template_url = base_path('/');
				$pdf->setSourceFile($template_url."resources/templates/certificate_template.pdf");
																		// import page 1
				$tplId = $pdf->importPage(1);	
				$pdf->useTemplate($tplId,0,0);
				$pdf->setPageMark();
							
				$pdf->setPrintHeader(false);
				$pdf->setPrintFooter(false);
				$org_rec = getSingleRecord('tra_organisation_information', array('id'=>1));
				$logo = getcwd() . '/resources/images/zamra-logo.png';
				$org_rec = getSingleRecord('tra_organisation_information', array('id'=>1));
				$logo = getcwd() . '/resources/images/zamra-logo.png';
				$pdf->SetFont('times', 'B', 12);
				$this->returnReportHeader($pdf,$org_rec,$rec,'RECEIPT');
				$import_fees_fob = '';
				if($module_id == 4){
					//service fee rate 
				}
				
				
				$pdf->SetFont('times','B',11);
				$pdf->Cell(70,7,strtoupper('Account Payee(From)'),0,0); 
				$pdf->Cell(0,7,strtoupper('Receipt Details'),0,1,'R');
				$pdf->SetFont('times', '', 11);
				$pdf->Cell(70,7,strtoupper($rec->applicant_name),0,0);
				$pdf->Cell(0,7,strtoupper('Payment Date:'.$rec->trans_date),0,1, 'R');
				$pdf->Cell(70,7,strtoupper($rec->postal_address.', '.$rec->region_name.', '.$rec->country_name),0,0);
				$pdf->Cell(0,7,strtoupper('Receipt Number: '.$rec->receipt_no),0,1,'R');
				$pdf->Cell(70,7,strtoupper($rec->email),0,0);
				$pdf->Cell(0,7,strtoupper('Payment Mode: '.$rec->payment_mode),0,1, 'R');
				
				$pdf->SetFont('times', 'b', 11);
				
				$pdf->Cell(0,7,strtoupper('Ref No:'. $rec->tracking_no .' '.$rec->reference_no),0,1, 'R');
				
				$pdf->ln();
				
				$pdf->SetFont('times', 'b', 11);
				
				$pdf->SetFont('times','',11);
				 $invoice_details = getInvoiceDetails($module_id, $application_id,$application_code);
				 $app_description= '';
				if(isset($invoice_details)){
					$app_description = $invoice_details['module_desc'];
				}
						$pdf->SetFont('times','B',11);
				$pdf->MultiCell(0,7,'Invoice Details for '.$rec->module_name.' ('.$rec->sub_module.') '.$app_description,0,'R',0,1);
				//invoice details 
				$pdf->SetLineWidth(0.1);
				$pdf->SetFont('times','B',11);
				$pdf->Cell(15,10,'Sn',1,0);
				$pdf->Cell(140,10,'Being Payment for: ',1,0,'C');
				$pdf->Cell(0,10,'Total',1,1,'C');
				$inv_rec = DB::table('payments_references as t1')
								->leftJoin('par_currencies as t2','t1.currency_id','t2.id')
								->leftJoin('tra_element_costs as t3','t1.element_costs_id','t3.id')
								->leftJoin('par_cost_elements as t4','t3.element_id','t4.id')
								->leftJoin('par_fee_types as t5','t3.feetype_id','t5.id')
								->leftJoin('par_cost_categories as t6','t3.cost_category_id','t6.id')
								->select(DB::raw(" t4.name AS cost_element, t5.name AS fee_type, t6.name AS cost_category, t1.amount_paid, t1.currency_id,t2.name as currency_name"))
								->where(array('t1.receipt_id'=>$payment_id))
								->get();
								
				if($inv_rec){
					$i = 1;
					$total_amount = 0;
					$currency_name = '';
					$currency_id = '';$pdf->SetLineWidth(0.1);
					foreach($inv_rec as $inv){
						$currency_name = $inv->currency_name;
						$cost_item = $inv->fee_type." ".$inv->cost_category." ".$inv->cost_element;
						$pdf->SetFont('times','',11);
							$rowcount = max($pdf->getNumLines($cost_item, 92),$pdf->getNumLines($inv->amount_paid, 40));
						$pdf->MultiCell(15,7*$rowcount,$i,1,'',0,0);
						$pdf->MultiCell(140,7*$rowcount,$cost_item,1,'',0,0);
						$pdf->MultiCell(0,7*$rowcount,formatMoney($inv->amount_paid),1,'R',0,1);
						$total_amount = $total_amount+$inv->amount_paid;
						
						$i++;
					}
					$pdf->SetFont('times','B',11);
					$pdf->MultiCell(155,10,'Sub-Total('.$currency_name.')',1,'R',0,0);
					$pdf->MultiCell(0,10,formatMoney($total_amount),1,'R',0,1);
						
					$pdf->MultiCell(155,10,'Received with thanks Total Amount('.$currency_name.')',1,'R',0,0);
					$pdf->MultiCell(0,10,formatMoney($total_amount),1,'R',0,1);
						
				}
				$pdf->SetFont('times','i',11);
				$pdf->MultiCell(0,7,'Amount in words '.ucwords(convert_number_to_words($rec->amount_paid)).'('.$currency_name.')'.' Only',1,'',0,1);
				$pdf->MultiCell(100,7,'Received By: Rwanda Food & Drugs Authority',1,'',0,0);
				$pdf->MultiCell(0,7,'Print Date: '.Carbon::now(),1,'',0,1);
					
				$pdf->Output('Receipt');
				
			
			}
			
		}
		else{
			echo "<h4>Receipt details Not Found</h4>";
		}
       
		
		
	}
	//the certificates helper functions 
	function printIportExportApprovals($application_code,$permit_watermark,$is_preview){
		
		
		$document_type_id = 25;
		$document_requirement_id = 254;
		
      
		if($is_preview){
			$permit_watermark = "Preview : ";
		}
        $approvalGrant = DB::table('tra_managerpermits_review')->where('application_code',$application_code)->first();
        if((!empty($approvalGrant) && $approvalGrant->decision_id == 1) || $is_preview){
			
			$record = DB::table('tra_importexport_applications as t1')
						->join('sub_modules as t2','t1.sub_module_id','t2.id')
						->select('t2.title', 't1.sub_module_id')
						->where('application_code',$application_code)->first();
						
						
						$sub_module_id = $record->sub_module_id;
			if($sub_module_id == 78 || $sub_module_id == 82){
				
				$this->printImportLicense($application_code,$record,$permit_watermark,$is_preview);
			}
			else if($sub_module_id == 81){
				$this->printExportLicense($application_code,$record,$permit_watermark,$is_preview);
			}
			else{
				$this->printImportExportvisa($application_code,$record,$permit_watermark,$is_preview);
			}
			
						
        }else if(!empty($approvalGrant) && $approvalGrant->decision_id== 2){
			echo "The Application has been rejected ".$approvalGrant->comment;
			
			
		}else{
           echo "No approval recommendation, contact the system admin";
			
        }
        
		
	}
}