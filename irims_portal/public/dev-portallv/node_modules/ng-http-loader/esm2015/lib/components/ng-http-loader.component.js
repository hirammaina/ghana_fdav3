/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,uselessCode} checked by tsc
 */
/*
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS
 * FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR
 * COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER
 * IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
 * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 */
import { Component, Input } from '@angular/core';
import { merge, timer } from 'rxjs';
import { debounce, distinctUntilChanged, partition, switchMap } from 'rxjs/operators';
import { PendingInterceptorService } from '../services/pending-interceptor.service';
import { SpinnerVisibilityService } from '../services/spinner-visibility.service';
import { Spinkit } from '../spinkits';
export class NgHttpLoaderComponent {
    /**
     * @param {?} pendingInterceptorService
     * @param {?} spinnerVisibilityService
     */
    constructor(pendingInterceptorService, spinnerVisibilityService) {
        this.pendingInterceptorService = pendingInterceptorService;
        this.spinnerVisibilityService = spinnerVisibilityService;
        this.spinkit = Spinkit;
        this.visibleUntil = Date.now();
        this.spinner = Spinkit.skCubeGrid;
        this.filteredUrlPatterns = [];
        this.filteredMethods = [];
        this.filteredHeaders = [];
        this.debounceDelay = 0;
        this.minDuration = 0;
        this.extraDuration = 0;
        this.entryComponent = null;
        const [showSpinner$, hideSpinner$] = partition((h) => h)(this.pendingInterceptorService.pendingRequestsStatus$);
        this.subscriptions = merge(this.pendingInterceptorService.pendingRequestsStatus$.pipe(switchMap(() => showSpinner$.pipe(debounce(() => timer(this.debounceDelay))))), showSpinner$.pipe(switchMap(() => hideSpinner$.pipe(debounce(() => this.getVisibilityTimer())))), this.spinnerVisibilityService.visibilityObservable$)
            .pipe(distinctUntilChanged())
            .subscribe(h => this.handleSpinnerVisibility(h));
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        this.nullifySpinnerIfEntryComponentIsDefined();
        this.initFilters();
    }
    /**
     * @return {?}
     */
    ngOnDestroy() {
        this.subscriptions.unsubscribe();
    }
    /**
     * @return {?}
     */
    nullifySpinnerIfEntryComponentIsDefined() {
        if (null != this.entryComponent) {
            this.spinner = null;
        }
    }
    /**
     * @return {?}
     */
    initFilters() {
        this.initFilteredUrlPatterns();
        this.initFilteredMethods();
        this.initFilteredHeaders();
    }
    /**
     * @return {?}
     */
    initFilteredUrlPatterns() {
        if (!(this.filteredUrlPatterns instanceof Array)) {
            throw new TypeError('`filteredUrlPatterns` must be an array.');
        }
        if (!!this.filteredUrlPatterns.length) {
            this.filteredUrlPatterns.forEach(e => this.pendingInterceptorService.filteredUrlPatterns.push(new RegExp(e)));
        }
    }
    /**
     * @return {?}
     */
    initFilteredMethods() {
        if (!(this.filteredMethods instanceof Array)) {
            throw new TypeError('`filteredMethods` must be an array.');
        }
        this.pendingInterceptorService.filteredMethods = this.filteredMethods;
    }
    /**
     * @return {?}
     */
    initFilteredHeaders() {
        if (!(this.filteredHeaders instanceof Array)) {
            throw new TypeError('`filteredHeaders` must be an array.');
        }
        this.pendingInterceptorService.filteredHeaders = this.filteredHeaders;
    }
    /**
     * @param {?} showSpinner
     * @return {?}
     */
    handleSpinnerVisibility(showSpinner) {
        if (showSpinner) {
            this.visibleUntil = Date.now() + this.minDuration;
        }
        this.isSpinnerVisible = showSpinner;
    }
    /**
     * @return {?}
     */
    getVisibilityTimer() {
        return timer(Math.max(this.extraDuration, this.visibleUntil - Date.now()));
    }
}
NgHttpLoaderComponent.decorators = [
    { type: Component, args: [{
                selector: 'ng-http-loader',
                template: "<div id=\"spinner\" *ngIf=\"isSpinnerVisible\">\n\n    <ng-container *ngComponentOutlet=\"entryComponent\"></ng-container>\n\n    <sk-cube-grid\n        *ngIf=\"spinner === spinkit.skCubeGrid\"\n        [backgroundColor]=\"backgroundColor\">\n    </sk-cube-grid>\n\n    <sk-chasing-dots\n        *ngIf=\"spinner === spinkit.skChasingDots\"\n        [backgroundColor]=\"backgroundColor\">\n    </sk-chasing-dots>\n\n    <sk-double-bounce\n        *ngIf=\"spinner === spinkit.skDoubleBounce\"\n        [backgroundColor]=\"backgroundColor\">\n    </sk-double-bounce>\n\n    <sk-rotating-plane\n        *ngIf=\"spinner === spinkit.skRotatingPlane\"\n        [backgroundColor]=\"backgroundColor\">\n    </sk-rotating-plane>\n\n    <sk-spinner-pulse\n        *ngIf=\"spinner === spinkit.skSpinnerPulse\"\n        [backgroundColor]=\"backgroundColor\">\n    </sk-spinner-pulse>\n\n    <sk-three-bounce\n        *ngIf=\"spinner === spinkit.skThreeBounce\"\n        [backgroundColor]=\"backgroundColor\">\n    </sk-three-bounce>\n\n    <sk-wandering-cubes\n        *ngIf=\"spinner === spinkit.skWanderingCubes\"\n        [backgroundColor]=\"backgroundColor\">\n    </sk-wandering-cubes>\n\n    <sk-wave\n        *ngIf=\"spinner === spinkit.skWave\"\n        [backgroundColor]=\"backgroundColor\">\n    </sk-wave>\n\n</div>\n\n",
                styles: ["#spinner{top:0;left:0;height:100%;width:100%;position:fixed;z-index:9999;display:flex;align-items:center;justify-content:center;opacity:.7;background-color:#f1f1f1}::ng-deep .colored-parent,::ng-deep .colored>div{background-color:#333}"]
            }] }
];
/** @nocollapse */
NgHttpLoaderComponent.ctorParameters = () => [
    { type: PendingInterceptorService },
    { type: SpinnerVisibilityService }
];
NgHttpLoaderComponent.propDecorators = {
    backgroundColor: [{ type: Input }],
    spinner: [{ type: Input }],
    filteredUrlPatterns: [{ type: Input }],
    filteredMethods: [{ type: Input }],
    filteredHeaders: [{ type: Input }],
    debounceDelay: [{ type: Input }],
    minDuration: [{ type: Input }],
    extraDuration: [{ type: Input }],
    entryComponent: [{ type: Input }]
};
if (false) {
    /** @type {?} */
    NgHttpLoaderComponent.prototype.isSpinnerVisible;
    /** @type {?} */
    NgHttpLoaderComponent.prototype.spinkit;
    /** @type {?} */
    NgHttpLoaderComponent.prototype.subscriptions;
    /** @type {?} */
    NgHttpLoaderComponent.prototype.visibleUntil;
    /** @type {?} */
    NgHttpLoaderComponent.prototype.backgroundColor;
    /** @type {?} */
    NgHttpLoaderComponent.prototype.spinner;
    /** @type {?} */
    NgHttpLoaderComponent.prototype.filteredUrlPatterns;
    /** @type {?} */
    NgHttpLoaderComponent.prototype.filteredMethods;
    /** @type {?} */
    NgHttpLoaderComponent.prototype.filteredHeaders;
    /** @type {?} */
    NgHttpLoaderComponent.prototype.debounceDelay;
    /** @type {?} */
    NgHttpLoaderComponent.prototype.minDuration;
    /** @type {?} */
    NgHttpLoaderComponent.prototype.extraDuration;
    /** @type {?} */
    NgHttpLoaderComponent.prototype.entryComponent;
    /** @type {?} */
    NgHttpLoaderComponent.prototype.pendingInterceptorService;
    /** @type {?} */
    NgHttpLoaderComponent.prototype.spinnerVisibilityService;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmctaHR0cC1sb2FkZXIuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vbmctaHR0cC1sb2FkZXIvIiwic291cmNlcyI6WyJsaWIvY29tcG9uZW50cy9uZy1odHRwLWxvYWRlci5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7O0FBU0EsT0FBTyxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQXFCLE1BQU0sZUFBZSxDQUFDO0FBQ3BFLE9BQU8sRUFBRSxLQUFLLEVBQTRCLEtBQUssRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUM5RCxPQUFPLEVBQUUsUUFBUSxFQUFFLG9CQUFvQixFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUN0RixPQUFPLEVBQUUseUJBQXlCLEVBQUUsTUFBTSx5Q0FBeUMsQ0FBQztBQUNwRixPQUFPLEVBQUUsd0JBQXdCLEVBQUUsTUFBTSx3Q0FBd0MsQ0FBQztBQUNsRixPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBT3RDLE1BQU07Ozs7O0lBeUJGLFlBQW9CLHlCQUFvRCxFQUFVLHdCQUFrRDtRQUFoSCw4QkFBeUIsR0FBekIseUJBQXlCLENBQTJCO1FBQVUsNkJBQXdCLEdBQXhCLHdCQUF3QixDQUEwQjt1QkF2Qm5ILE9BQU87NEJBRU8sSUFBSSxDQUFDLEdBQUcsRUFBRTt1QkFLeEIsT0FBTyxDQUFDLFVBQVU7bUNBRUksRUFBRTsrQkFFTixFQUFFOytCQUVGLEVBQUU7NkJBRWQsQ0FBQzsyQkFFSCxDQUFDOzZCQUVDLENBQUM7OEJBRUssSUFBSTtRQUc3QixNQUFNLENBQUMsWUFBWSxFQUFFLFlBQVksQ0FBQyxHQUFHLFNBQVMsQ0FBQyxDQUFDLENBQVUsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLHlCQUF5QixDQUFDLHNCQUFzQixDQUFDLENBQUM7UUFFekgsSUFBSSxDQUFDLGFBQWEsR0FBRyxLQUFLLENBQ3RC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U0FBUyxTQUFDO2dCQUNQLFFBQVEsRUFBRSxnQkFBZ0I7Z0JBQzFCLGl6Q0FBOEM7O2FBRWpEOzs7O1lBUlEseUJBQXlCO1lBQ3pCLHdCQUF3Qjs7OzhCQWM1QixLQUFLO3NCQUVMLEtBQUs7a0NBRUwsS0FBSzs4QkFFTCxLQUFLOzhCQUVMLEtBQUs7NEJBRUwsS0FBSzswQkFFTCxLQUFLOzRCQUVMLEtBQUs7NkJBRUwsS0FBSyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgXCJBUyBJU1wiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SXG4gKiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSwgRklUTkVTU1xuICogRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRSBBVVRIT1JTIE9SXG4gKiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUiBMSUFCSUxJVFksIFdIRVRIRVJcbiAqIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwgT1VUIE9GIE9SIElOXG4gKiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4gVEhFIFNPRlRXQVJFLlxuICovXG5cbmltcG9ydCB7IENvbXBvbmVudCwgSW5wdXQsIE9uRGVzdHJveSwgT25Jbml0IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBtZXJnZSwgT2JzZXJ2YWJsZSwgU3Vic2NyaXB0aW9uLCB0aW1lciB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgZGVib3VuY2UsIGRpc3RpbmN0VW50aWxDaGFuZ2VkLCBwYXJ0aXRpb24sIHN3aXRjaE1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IFBlbmRpbmdJbnRlcmNlcHRvclNlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlcy9wZW5kaW5nLWludGVyY2VwdG9yLnNlcnZpY2UnO1xuaW1wb3J0IHsgU3Bpbm5lclZpc2liaWxpdHlTZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmljZXMvc3Bpbm5lci12aXNpYmlsaXR5LnNlcnZpY2UnO1xuaW1wb3J0IHsgU3BpbmtpdCB9IGZyb20gJy4uL3NwaW5raXRzJztcblxuQENvbXBvbmVudCh7XG4gICAgc2VsZWN0b3I6ICduZy1odHRwLWxvYWRlcicsXG4gICAgdGVtcGxhdGVVcmw6ICcuL25nLWh0dHAtbG9hZGVyLmNvbXBvbmVudC5odG1sJyxcbiAgICBzdHlsZVVybHM6IFsnLi9uZy1odHRwLWxvYWRlci5jb21wb25lbnQuc2NzcyddXG59KVxuZXhwb3J0IGNsYXNzIE5nSHR0cExvYWRlckNvbXBvbmVudCBpbXBsZW1lbnRzIE9uRGVzdHJveSwgT25Jbml0IHtcbiAgICBwdWJsaWMgaXNTcGlubmVyVmlzaWJsZTogYm9vbGVhbjtcbiAgICBwdWJsaWMgc3BpbmtpdCA9IFNwaW5raXQ7XG4gICAgcHJpdmF0ZSBzdWJzY3JpcHRpb25zOiBTdWJzY3JpcHRpb247XG4gICAgcHJpdmF0ZSB2aXNpYmxlVW50aWw6IG51bWJlciA9IERhdGUubm93KCk7XG5cbiAgICBASW5wdXQoKVxuICAgIHB1YmxpYyBiYWNrZ3JvdW5kQ29sb3I6IHN0cmluZztcbiAgICBASW5wdXQoKVxuICAgIHB1YmxpYyBzcGlubmVyID0gU3BpbmtpdC5za0N1YmVHcmlkO1xuICAgIEBJbnB1dCgpXG4gICAgcHVibGljIGZpbHRlcmVkVXJsUGF0dGVybnM6IHN0cmluZ1tdID0gW107XG4gICAgQElucHV0KClcbiAgICBwdWJsaWMgZmlsdGVyZWRNZXRob2RzOiBzdHJpbmdbXSA9IFtdO1xuICAgIEBJbnB1dCgpXG4gICAgcHVibGljIGZpbHRlcmVkSGVhZGVyczogc3RyaW5nW10gPSBbXTtcbiAgICBASW5wdXQoKVxuICAgIHB1YmxpYyBkZWJvdW5jZURlbGF5ID0gMDtcbiAgICBASW5wdXQoKVxuICAgIHB1YmxpYyBtaW5EdXJhdGlvbiA9IDA7XG4gICAgQElucHV0KClcbiAgICBwdWJsaWMgZXh0cmFEdXJhdGlvbiA9IDA7XG4gICAgQElucHV0KClcbiAgICBwdWJsaWMgZW50cnlDb21wb25lbnQ6IGFueSA9IG51bGw7XG5cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIHBlbmRpbmdJbnRlcmNlcHRvclNlcnZpY2U6IFBlbmRpbmdJbnRlcmNlcHRvclNlcnZpY2UsIHByaXZhdGUgc3Bpbm5lclZpc2liaWxpdHlTZXJ2aWNlOiBTcGlubmVyVmlzaWJpbGl0eVNlcnZpY2UpIHtcbiAgICAgICAgY29uc3QgW3Nob3dTcGlubmVyJCwgaGlkZVNwaW5uZXIkXSA9IHBhcnRpdGlvbigoaDogYm9vbGVhbikgPT4gaCkodGhpcy5wZW5kaW5nSW50ZXJjZXB0b3JTZXJ2aWNlLnBlbmRpbmdSZXF1ZXN0c1N0YXR1cyQpO1xuXG4gICAgICAgIHRoaXMuc3Vic2NyaXB0aW9ucyA9IG1lcmdlKFxuICAgICAgICAgICAgdGhpcy5wZW5kaW5nSW50ZXJjZXB0b3JTZXJ2aWNlLnBlbmRpbmdSZXF1ZXN0c1N0YXR1cyQucGlwZShcbiAgICAgICAgICAgICAgICBzd2l0Y2hNYXAoKCkgPT4gc2hvd1NwaW5uZXIkLnBpcGUoZGVib3VuY2UoKCkgPT4gdGltZXIodGhpcy5kZWJvdW5jZURlbGF5KSkpKVxuICAgICAgICAgICAgKSxcbiAgICAgICAgICAgIHNob3dTcGlubmVyJC5waXBlKFxuICAgICAgICAgICAgICAgIHN3aXRjaE1hcCgoKSA9PiBoaWRlU3Bpbm5lciQucGlwZShkZWJvdW5jZSgoKSA9PiB0aGlzLmdldFZpc2liaWxpdHlUaW1lcigpKSkpXG4gICAgICAgICAgICApLFxuICAgICAgICAgICAgdGhpcy5zcGlubmVyVmlzaWJpbGl0eVNlcnZpY2UudmlzaWJpbGl0eU9ic2VydmFibGUkLFxuICAgICAgICApXG4gICAgICAgICAgICAucGlwZShkaXN0aW5jdFVudGlsQ2hhbmdlZCgpKVxuICAgICAgICAgICAgLnN1YnNjcmliZShoID0+IHRoaXMuaGFuZGxlU3Bpbm5lclZpc2liaWxpdHkoaCkpO1xuICAgIH1cblxuICAgIG5nT25Jbml0KCk6IHZvaWQge1xuICAgICAgICB0aGlzLm51bGxpZnlTcGlubmVySWZFbnRyeUNvbXBvbmVudElzRGVmaW5lZCgpO1xuICAgICAgICB0aGlzLmluaXRGaWx0ZXJzKCk7XG4gICAgfVxuXG4gICAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XG4gICAgICAgIHRoaXMuc3Vic2NyaXB0aW9ucy51bnN1YnNjcmliZSgpO1xuICAgIH1cblxuICAgIHByaXZhdGUgbnVsbGlmeVNwaW5uZXJJZkVudHJ5Q29tcG9uZW50SXNEZWZpbmVkKCk6IHZvaWQge1xuICAgICAgICBpZiAobnVsbCAhPSB0aGlzLmVudHJ5Q29tcG9uZW50KSB7XG4gICAgICAgICAgICB0aGlzLnNwaW5uZXIgPSBudWxsO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBpbml0RmlsdGVycygpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5pbml0RmlsdGVyZWRVcmxQYXR0ZXJucygpO1xuICAgICAgICB0aGlzLmluaXRGaWx0ZXJlZE1ldGhvZHMoKTtcbiAgICAgICAgdGhpcy5pbml0RmlsdGVyZWRIZWFkZXJzKCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBpbml0RmlsdGVyZWRVcmxQYXR0ZXJucygpOiB2b2lkIHtcbiAgICAgICAgaWYgKCEodGhpcy5maWx0ZXJlZFVybFBhdHRlcm5zIGluc3RhbmNlb2YgQXJyYXkpKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdgZmlsdGVyZWRVcmxQYXR0ZXJuc2AgbXVzdCBiZSBhbiBhcnJheS4nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghIXRoaXMuZmlsdGVyZWRVcmxQYXR0ZXJucy5sZW5ndGgpIHtcbiAgICAgICAgICAgIHRoaXMuZmlsdGVyZWRVcmxQYXR0ZXJucy5mb3JFYWNoKGUgPT5cbiAgICAgICAgICAgICAgICB0aGlzLnBlbmRpbmdJbnRlcmNlcHRvclNlcnZpY2UuZmlsdGVyZWRVcmxQYXR0ZXJucy5wdXNoKG5ldyBSZWdFeHAoZSkpXG4gICAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBpbml0RmlsdGVyZWRNZXRob2RzKCk6IHZvaWQge1xuICAgICAgICBpZiAoISh0aGlzLmZpbHRlcmVkTWV0aG9kcyBpbnN0YW5jZW9mIEFycmF5KSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignYGZpbHRlcmVkTWV0aG9kc2AgbXVzdCBiZSBhbiBhcnJheS4nKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnBlbmRpbmdJbnRlcmNlcHRvclNlcnZpY2UuZmlsdGVyZWRNZXRob2RzID0gdGhpcy5maWx0ZXJlZE1ldGhvZHM7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBpbml0RmlsdGVyZWRIZWFkZXJzKCk6IHZvaWQge1xuICAgICAgICBpZiAoISh0aGlzLmZpbHRlcmVkSGVhZGVycyBpbnN0YW5jZW9mIEFycmF5KSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignYGZpbHRlcmVkSGVhZGVyc2AgbXVzdCBiZSBhbiBhcnJheS4nKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnBlbmRpbmdJbnRlcmNlcHRvclNlcnZpY2UuZmlsdGVyZWRIZWFkZXJzID0gdGhpcy5maWx0ZXJlZEhlYWRlcnM7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBoYW5kbGVTcGlubmVyVmlzaWJpbGl0eShzaG93U3Bpbm5lcjogYm9vbGVhbik6IHZvaWQge1xuICAgICAgICBpZiAoc2hvd1NwaW5uZXIpIHtcbiAgICAgICAgICAgIHRoaXMudmlzaWJsZVVudGlsID0gRGF0ZS5ub3coKSArIHRoaXMubWluRHVyYXRpb247XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5pc1NwaW5uZXJWaXNpYmxlID0gc2hvd1NwaW5uZXI7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRWaXNpYmlsaXR5VGltZXIoKTogT2JzZXJ2YWJsZTxudW1iZXI+IHtcbiAgICAgICAgcmV0dXJuIHRpbWVyKE1hdGgubWF4KHRoaXMuZXh0cmFEdXJhdGlvbiwgdGhpcy52aXNpYmxlVW50aWwgLSBEYXRlLm5vdygpKSk7XG4gICAgfVxufVxuIl19